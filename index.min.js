/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e=function(e){return Array.isArray(e)},r=function(e,r){return e&&i(r)&&e instanceof r},t=function(e){return n(e)&&0==e%1},n=function(e){return"number"==typeof e},i=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return e.length},s=function(e){return Object.keys(e)},u=function(e,t){return function(e){return r(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,i(t)?t:"g"))},a=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},o=function t(n){if(e(n))return n.map((function(e){return t(n)}));if(function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||r(e,Object))}(n)){for(var i in n)n[i]=t(n[i]);return n}return!1===n?"false":null===n?"null":!0===n?"true":""+n},l=function(e){return e&&e.preventDefault()},f=function(e){return"</("+e+")>"},p=function(){return"[\\w:.-]+"},d=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},$=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+f(p())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+p()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+d(p())+")"};function m(e){var r,n=this,i=n.k(!1).pop(),s=n.k();if(n&&!e.defaultPrevented&&!n.keys[s]&&"Alt"!==s&&"Control"!==s){var a=n.$(),o=a.after,m=a.before;a.end;var v=a.start,A=a.value;if(["-",">","/","?"," "].includes(i)){if("-"===i)return A||"<!-"!==m.slice(-3)?void 0:(l(e),n.wrap("- "," --"+(">"===o[0]?"":">")).record());if(">"===i||"/"===i){var x=u(d(p())+"$","").exec(m+">");if(!A&&x){if(l(e),"/"===i)return">"===o[0]?n.trim("",!1).insert(" /",-1).select(n.$().start+1).record():n.trim("",!1).insert(" />",-1).record();o.startsWith("></"+x[1]+">")?n.select(v+1).record():o.startsWith("</"+x[1]+">")?n.insert(">",-1).record():n.wrap(">","</"+x[1]+(">"===o[0]?"":">")).record()}return}return"?"===i?A||"<"!==m.slice(-1)?void 0:(l(e),n.wrap("?","?"+(">"===o[0]?"":">")).record()):" "===i&&!A&&("--\x3e"===o.slice(0,3)&&"\x3c!--"===m.slice(-4)||"?>"===o.slice(0,2)&&/<\?\S*$/.test(m))?(l(e),n.wrap(" "," ").record()):void 0}var g=n.$();if(o=g.after,m=g.before,g.end,v=g.start,A=g.value,"ArrowLeft"!==s){if("ArrowRight"!==s){var w=(null==(r=n.state.source)?void 0:r.tab)||n.state.tab||"\t",D=m.split("\n").pop().match(/^(\s+)/),C=D&&D[1]||"";if(t(w)&&(w=" ".repeat(w)),"Enter"===s){if(A)return;if(/^[ \t]*-->/.test(o)&&/<!--[ \t]*$/.test(m)||/^[ \t]*\?>/.test(o)&&/<\?\S*[ \t]*$/.test(m)||/^[ \t]*\]\]>/.test(o)&&/<!\[CDATA\[[ \t]*$/.test(m))return l(e),n.trim("\n"+C,"\n"+C).record();if(/^(\n[ \t]*)-->/.test(o)&&/<!--(\n[ \t]*)$/.test(m)||/^(\n[ \t]*)\?>/.test(o)&&/<\?\S*(\n[ \t]*)$/.test(m)||/^(\n[ \t]*)\]\]>/.test(o)&&/<!\[CDATA\[(\n[ \t]*)$/.test(m))return l(e),n.trim("\n\n"+C,"\n\n"+C).record();var T=m.match(u(d(p())+"$",""));if(T)return l(e),o.startsWith("</"+T[1]+">")?n.record().trim("\n"+C+w,"\n"+C).record():n.record().wrap("\n"+C+w,"\n"+C+"</"+T[1]+">").record()}if("Backspace"===s){if(A)return;if("\x3c!--"===m.slice(-4))return l(e),n.replace(/<!--$/,"",-1),"--\x3e"===o.slice(0,3)&&n.replace(/^-->/,"",1),n.record();if(/^(\n[ \t]*){2,}-->/.test(o)&&/<!--(\n[ \t]*){2,}$/.test(m))return l(e),n.trim("\n"+C,"\n"+C).record();if(/^\s+-->/.test(o)&&/<!--\s+$/.test(m)){l(e);var h=o[0],b=m.slice(-1),S=" "===h&&" "===b?"":" ";return n.trim(S,S).record()}if(/<\?\S*$/.test(m))return l(e),n.replace(/<\?\S*$/,"",-1),"?>"===o.slice(0,2)&&n.replace(/^\?>/,"",1),n.record();if(/^(\n[ \t]*){2,}\?>/.test(o)&&/<\?\S*(\n[ \t]*){2,}$/.test(m))return l(e),n.trim("\n"+C,"\n"+C).record();if(/^\s+\?>/.test(o)&&/<\?\S*\s+$/.test(m)){l(e);var y=o[0],E=m.slice(-1),k=" "===y&&" "===E?"":" ";return n.trim(k,k).record()}if("<![CDATA["===m.slice(-9))return l(e),n.replace(/<!\[CDATA\[$/,"",-1),"]]>"===o.slice(0,3)&&n.replace(/^\]\]>/,"",1),n.record();if(/^(\n[ \t]*){2,}\]\]>/.test(o)&&/<!\[CDATA\[(\n[ \t]*){2,}$/.test(m))return l(e),n.trim("\n"+C,"\n"+C).record();if(/^\s+\]\]>/.test(o)&&/<!\[CDATA\[\s+$/.test(m)){l(e);var j=o[0],W=m.slice(-1),L=" "===j&&" "===W?"":" ";return n.trim(L,L).record()}var R=u($()+"$",""),M=R.exec(m);if(M){if(l(e)," />"===m.slice(-3))return n.replace(/ \/>$/,"/>",-1).record();if("/>"===m.slice(-2))return n.replace(/\/>$/,">",-1).record();n.replace(R,"",-1);var O=M[0].slice(1).split(/\s+|>/)[0];return M[0]&&"/"!==M[0][1]&&o.startsWith("</"+O+">")&&n.replace(u("^</"+O+">",""),"",1),n.record()}if(u("(^|\\n)([ \\t]*)"+d(p())+"\\n\\2$","").test(m)&&u("^\\s*"+f(p()),"").test(o))return l(e),n.trim().record()}if("Delete"===s){if(A)return;if("--\x3e"===o.slice(0,3))return l(e),n.replace(/^-->/,"",1).record();if("?>"===o.slice(0,2))return l(e),n.replace(/^\?>/,"",1).record();var X=u("^"+$(),"");if(X.exec(o))return l(e),n.replace(X,"",1).record()}}else if(!A){var q=u("^"+$(),"").exec(o);if(q)return l(e),n.select(v,v+c(q[0]))}}else if(!A){var B=u($()+"$","").exec(m);if(B)return l(e),n.select(v-c(B[0]),v)}}}function v(e){if(!e)return"";e=s(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+a(o(t),!0)+'"'));return n}return{attach:function(){var r,t=this,n=/^\s*([\s\S]*?)\s*$/,c=/^<!--\s*([\s\S]*?)\s*-->$/,s=/^<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>$/;return t.insertComment=function(e,r,n){return t.insert("\x3c!-- "+e+" --\x3e",i(r)?r:-1,!i(n)||n)},t.insertData=function(e,r,n){return t.insert("<![CDATA["+e+"]]>",i(r)?r:-1,!i(n)||n)},t.insertElement=function(r,n,c){return e(r)&&(r="<"+r[0]+v(r[2])+(!1===r[1]?" />":">"+(r[1]||"")+"</"+r[0]+">")),t.insert(r,i(n)?n:-1,!i(c)||c)},t.peelComment=function(e){return e?t.replace(c,"$1"):t.replace(/<!--\s*$/,"",-1).replace(/^\s*-->/,"",1)},t.peelData=function(e){return e?t.replace(s,"$1"):t.replace(/<!\[CDATA\[\s*$/,"",-1).replace(/^\s*\]\]>/,"",1)},t.peelElement=function(r,n,i){return e(r)?(i=n)?t.replace(u("^"+d(r[0])+"([\\s\\S]*?)"+f(r[0])+"$",""),"$3"):t.replace(u(d(r[0])+"$",""),"",-1).replace(u("^"+f(r[0])),"",1):t.peel(r,n,i)},t.toggleComment=function(e){var r=t.$(),n=r.after,i=r.before,s=r.value;return e?t[(c.test(s)?"peel":"wrap")+"Comment"](e):t[(/<!--\s*$/.test(i)&&/^\s*-->/.test(n)?"peel":"wrap")+"Comment"](e)},t.toggleData=function(e){var r=t.$(),n=r.after,i=r.before,c=r.value;return e?t[(s.test(c)?"peel":"wrap")+"Data"](e):t[(/<!\[CDATA\[\s*$/.test(i)&&/^\s*\]\]>/.test(n)?"peel":"wrap")+"Data"](e)},t.toggleElement=function(r,n,i){if(e(r)){i=n;var c=t.$(),s=c.after,a=c.before,o=c.value,l=d(r[0]),p=f(r[0]);return i?t[(u("^"+l+"[\\s\\S]*?"+p+"$","").test(o)?"peel":"wrap")+"Element"](r,n,i):t[(u(l+"$","").test(a)&&u("^"+p,"").test(s)?"peel":"wrap")+"Element"](r,n,i)}return t.toggle(r,n,i)},t.wrapComment=function(e){return e?t.replace(n,"\x3c!-- $1 --\x3e"):t.trim(!1,!1).replace(/$/,"\x3c!-- ",-1).replace(/^/," --\x3e",1)},t.wrapData=function(e){return e?t.replace(n,"<![CDATA[$1]]>"):t.trim(!1,!1).replace(/$/,"<![CDATA[",-1).replace(/^/,"]]>",1)},t.wrapElement=function(r,i,c){if(e(r)){c=i;var s=t.$().value;return c?t.replace(n,"<"+r[0]+v(r[2])+">"+(s||r[1]||"").trim()+"</"+r[0]+">"):t.trim(!1,!1).replace(/$/,"<"+r[0]+v(r[2])+">",-1).replace(/^/,"</"+r[0]+">",1).insert(s||r[1]||"")}return t.wrap(r,i,c)},"XML"===(null==(r=t.state.source)?void 0:r.type)&&t.on("key.down",m),t},detach:function(){return this.off("key.down",m)}}}));