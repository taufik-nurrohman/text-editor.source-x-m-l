/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman
 *
 * <https://github.com/taufik-nurrohman/text-editor.source-x-m-l>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceXML=r())}(this,(function(){"use strict";var e=function(e,t){return e&&r(t)&&e instanceof t},r=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},t=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")},n=function r(t){if(function(e){return Array.isArray(e)}(t))return t.map((function(e){return r(t)}));if(function(r,t){return void 0===t&&(t=!0),"object"==typeof r&&(!t||e(r,Object))}(t)){for(var n in t)t[n]=r(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},c=function(e){return e.length},i=function(t,n){return function(r){return e(r,RegExp)}(t)?t:(t=t.replace(/\//g,"\\/"),RegExp(t,r(n)?n:"g"))},l="!$^*()+=[]{}|:<>,.?/-";let f="[\\w:.-]+",o=e=>"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",u=e=>"</("+e+")>",s="(?:\x3c!--([\\s\\S]*?)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+u(f)+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+o(f)+"|"+("<("+f+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>)");const a={};return a.toggle=function(e,r="",c={}){let l=this,{after:f,before:s,value:a}=l.$(),p=o(e),d=u(e),$=i(p+"$",""),x=i("^"+d,""),g=$.test(s),w=x.test(f);return w&&g?l.replace(x,"",1).replace($,"",-1):($=i("^"+p,""),x=i(d+"$",""),g=$.test(a),w=x.test(a),w&&g&&l.insert(a=a.replace(x,"").replace($,"")),!a&&r&&l.insert(r),l.wrap("<"+e+function(e){let r,c="";for(r in e)c+=" "+r+'="'+t(n(e[r]))+'"';return c}(c)+">","</"+e+">"))},{canKeyDown:function(e,{a:r,c:t,s:n},a){let p=a.state.tab||"\t";if(r||t)return!0;if(["-",">","/","?"," "].includes(e)){let{after:r,before:t,value:n,start:l}=a.$();if("-"===e&&!n&&"<!-"===t.slice(-3))return a.wrap("- "," --"+(">"===r[0]?"":">")).record(),!1;if(">"===e||"/"===e){let u=i(o(f)+"$","").exec(t+">");if(!n&&u)return"/"===e?">"===r[0]?(a.trim("",!1).insert(" /",-1).select(a.$().start+1).record(),!1):(a.trim("",!1).insert(" />",-1).record(),!1):("></"+u[1]+">"===r.slice(0,c(u[1])+4)?a.select(l+1).record():"</"+u[1]+">"===r.slice(0,c(u[1])+3)?a.insert(">",-1).record():a.wrap(">","</"+u[1]+(">"===r[0]?"":">")).record(),!1)}if("?"===e&&!n&&"<"===t.slice(-1))return a.wrap("?","?"+(">"===r[0]?"":">")).record(),!1;if(" "===e&&!n&&"\x3c!--"===t.slice(-4)&&"--\x3e"===r.slice(0,3))return a.wrap(" "," ").record(),!1}if("ArrowLeft"===e&&!n){let{before:e,start:r,value:t}=a.$();if(!t){let t=i(s+"$","").exec(e);if(t)return a.select(t.index,r),!1}}if("ArrowRight"===e&&!n){let{after:e,start:r,value:t}=a.$();if(!t){let t=i("^"+s,"").exec(e);if(t)return a.select(r,r+c(t[0])),!1}}if("Enter"===e&&!n){let{after:e,before:r,value:t}=a.$(),n=r.split("\n").pop().match(/^(\s+)/),c=n&&n[1]||"",l=r.match(i(o(f)+"$",""));if(!t&&/^[ \t]*-->/.test(e)&&/<!--[ \t]*$/.test(r))return a.trim().wrap("\n\n"+c,"\n\n"+c).record(),!1;if(!t&&l)return i("^</"+l[1]+">","").test(e)?a.record().trim().wrap("\n"+c+p,"\n"+c).record():a.record().wrap("\n"+c+p,"\n"+c+"</"+l[1]+">").record(),!1}if("Backspace"===e&&!n){let{after:e,before:r,value:t}=a.$();if(!t){if("\x3c!--"===r.slice(-4))return a.replace(/<!--$/,"",-1),"--\x3e"===e.slice(0,3)&&a.replace(/^-->/,"",1),a.record(),!1;if(/^\s+-->/.test(e)&&/<!--\s+$/.test(r))return a.trim(" "===r.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;if("<?"===r.slice(-2))return a.replace(/<\?$/,"",-1),"?>"===e.slice(0,2)&&a.replace(/^\?>/,"",1),a.record(),!1;let t=i(s+"$",""),n=t.exec(r);if(n){if(" />"===r.slice(-3))return a.replace(/ \/>$/,"/>",-1).record(),!1;if("/>"===r.slice(-2))return a.replace(/\/>$/,">",-1).record(),!1;a.replace(t,"",-1);let l=n[0].slice(1).split(/\s+|>/)[0];return n[0]&&"/"!==n[0][1]&&"</"+l+">"===e.slice(0,c(l)+3)&&a.replace(i("^</"+l+">",""),"",1),a.record(),!1}if(i(o(f)+"\\n(?:"+(d=p,void 0===$&&($=""),d.replace(i("["+$+l.replace(/./g,"\\$&")+"]"),"\\$&")+")?$"),"").test(r)&&i("^\\s*"+u(f),"").test(e))return a.trim().record(),!1}}var d,$;if("Delete"===e&&!n){let{after:e,value:r}=a.$();if(!r){if("--\x3e"===e.slice(0,3))return a.replace(/^-->/,"",1).record(),!1;if("?>"===e.slice(0,2))return a.replace(/^\?>/,"",1).record(),!1;let r=i("^"+s,"");if(r.exec(e))return a.replace(r,"",1).record(),!1}}return!0},canMouseDown:function(e){return setTimeout((()=>{let{after:r,before:t,value:n}=e.$();if(!n){let l,f,o="\ufeff",u=s.split("([\\w:.-]+)").join("((?:[\\w:.-]|"+o+")+)"),a=i(u),p=t+n+o+r;for(;l=a.exec(p);)if(-1!==l[0].indexOf(o)){e.select(f=l.index,f+c(l[0])-1);break}}}),1),!0},state:{},that:a}}));