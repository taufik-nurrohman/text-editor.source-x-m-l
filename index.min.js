/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e=function(e,t){return e&&r(t)&&e instanceof t},r=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},t=function(e){return e.length},n=function(e){return Object.keys(e)},i=function(e,r){return void 0===r&&(r=""),e.replace(c("["+r+o.replace(/./g,"\\$&")+"]"),"\\$&")},c=function(t,n){return function(r){return e(r,RegExp)}(t)?t:(t=t.replace(/\//g,"\\/"),RegExp(t,r(n)?n:"g"))},o="!$^*()+=[]{}|:<>,.?/-",u=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},s=function r(t){if(function(e){return Array.isArray(e)}(t))return t.map((function(e){return r(t)}));if(function(r,t){return void 0===t&&(t=!0),"object"==typeof r&&(!t||e(r,Object))}(t)){for(var n in t)t[n]=r(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},a=function(e,r,t){r.removeEventListener(e,t)},f=function(e){return e&&e.preventDefault()},l=function(e,r,t,n){void 0===n&&(n=!1),r.addEventListener(e,t,n)},d=function(){return"[\\w:.-]+"},p=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(e){return"</("+e+")>"},x=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+v(d())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+d()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+p(d())+")"};function m(e){}function h(e){var r,n=this.TextEditor,o=n.k();if(n&&!e.defaultPrevented&&!n.keys[o]&&"Alt"!==o&&"Control"!==o){var u=o.split("-").pop(),s=n.$(),a=s.after,l=s.before;s.end;var $=s.start,m=s.value;if(""===u&&(u="-"),["-",">","/","?"," "].includes(u)){if("-"===u)return m||"<!-"!==l.slice(-3)?void 0:(f(e),n.wrap("- "," --"+(">"===a[0]?"":">")).record());if(">"===u||"/"===u){var h=c(p(d())+"$","").exec(l+">");if(!m&&h){if(f(e),"/"===u)return">"===a[0]?n.trim("",!1).insert(" /",-1).select(n.$().start+1).record():n.trim("",!1).insert(" />",-1).record();a.startsWith("></"+h[1]+">")?n.select($+1).record():a.startsWith("</"+h[1]+">")?n.insert(">",-1).record():n.wrap(">","</"+h[1]+(">"===a[0]?"":">")).record()}return}return"?"===u?m||"<"!==l.slice(-1)?void 0:(f(e),n.wrap("?","?"+(">"===a[0]?"":">")).record()):" "===u&&!m&&("--\x3e"===a.slice(0,3)&&"\x3c!--"===l.slice(-4)||"?>"===a.slice(0,2)&&"<?"===l.slice(0,2)&&/<\?\S*$/.test(l))?(f(e),n.wrap(" "," ").record()):void 0}var w=n.$();if(a=w.after,l=w.before,w.end,$=w.start,m=w.value,"ArrowLeft"!==o){if("ArrowRight"!==o){var b=(null==(r=n.state.source)?void 0:r.tab)||n.state.tab||"\t",g=l.split("\n").pop().match(/^(\s+)/),y=g&&g[1]||"";if("Enter"!==o){if("Backspace"!==o){if("Delete"===keyValue&&!m){if("--\x3e"===a.slice(0,3))return f(e),n.replace(/^-->/,"",1).record();if("?>"===a.slice(0,2))return f(e),n.replace(/^\?>/,"",1).record();var L=c("^"+x(),"");if(L.exec(a))return f(e),n.replace(L,"",1).record()}}else if(!m){if("\x3c!--"===l.slice(-4))return f(e),n.replace(/<!--$/,"",-1),"--\x3e"===a.slice(0,3)&&n.replace(/^-->/,"",1),n.record();if(/^\s+-->/.test(a)&&/<!--\s+$/.test(l))return f(e),n.trim(" "===l.slice(-1)?"":" "," "===a[0]?"":" ").record();if(/<\?\S*$/.test(l))return f(e),n.replace(/<\?\S*$/,"",-1),"?>"===a.slice(0,2)&&n.replace(/^\?>/,"",1),n.record();if(/^\s+\?>/.test(a)&&/<\?\S*\s+$/.test(l))return f(e),n.trim(" "===l.slice(-1)?"":" "," "===a[0]?"":" ").record();var k=c(x()+"$",""),E=k.exec(l);if(E){if(f(e)," />"===l.slice(-3))return n.replace(/ \/>$/,"/>",-1).record();if("/>"===l.slice(-2))return n.replace(/\/>$/,">",-1).record();n.replace(k,"",-1);var M=E[0].slice(1).split(/\s+|>/)[0];return E[0]&&"/"!==E[0][1]&&a.startsWith("</"+M+">")&&n.replace(c("^</"+M+">",""),"",1),n.record()}if(c(p(d())+"\\n(?:"+i(b)+")?$","").test(l)&&c("^\\s*"+v(d()),"").test(a))return f(e),n.trim().record()}}else{var S=l.match(c(p(d())+"$",""));if(!m){if(S)return f(e),a.startsWith("</"+S[1]+">")?n.record().trim().wrap("\n"+y+b,"\n"+y).record():n.record().wrap("\n"+y+b,"\n"+y+"</"+S[1]+">").record();if(/^[ \t]*-->/.test(a)&&/<!--[ \t]*$/.test(l)||/^[ \t]*\?>/.test(a)&&/<\?\S*[ \t]*$/.test(l))return f(e),n.trim().wrap("\n"+y,"\n"+y).record()}}}else if(!m){var X=c("^"+x(),"").exec(a);if(X)return f(e),n.select($,$+t(X[0]))}}else if(!m){var T=c(x()+"$","").exec(l);if(T)return f(e),n.select($-t(T[0]),$)}}}function w(e){}function b(e){}function g(e){if(!e)return"";e=n(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,i="";for(r in e)!1!==(t=e[r])&&null!==t&&(i+=" "+r,!0!==t&&(i+='="'+u(s(t),!0)+'"'));return i}return{attach:function(e){var r,t=this;return t.insertXML=function(e,r,n,i){if(void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1),i){var o,u=t.$(),s=u.after,a=u.before,f=(null==(o=t.state.source)?void 0:o.tab)||t.state.tab||"\t";if(c("^"+v(d()),"").test(s)&&c(p(d())+"$","").test(a)){var l=a.split("\n").pop().match(/^(\s+)/),$=l&&l[1]||"";t.wrap("\n"+f+$,"\n"+$)}}return t.insert("<"+e+g(n)+(!1!==r?">"+r+"</"+e+">":" />"),-1,!0)},t.peelXML=function(e,r,n,i){return void 0===i&&(i=!1),i&&t.trim("",""),t.replace(c(p(e)+"$",""),"",-1).replace(c("^"+v(e)),"",1)},t.toggleXML=function(e,r,n,i){void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1);var o=t.$(),u=o.after,s=o.before,a=p(e),f=v(e),l=c(a+"$",""),d=c("^"+f,""),$=l.test(s),x=d.test(u);return t[($&&x?"peel":"wrap")+"XML"](e,r,n,i)},t.wrapXML=function(e,r,n,i){void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1);var o=t.$(),u=o.after,s=o.before;if(!o.value&&r&&t.insert(r),i){var a,f=(null==(a=t.state.source)?void 0:a.tab)||t.state.tab||"\t";if(c("^"+v(d()),"").test(u)&&c(p(d())+"$","").test(s)){var l=s.split("\n").pop().match(/^(\s+)/),$=l&&l[1]||"";t.wrap("\n"+f+$,"\n"+$)}}return t.wrap("<"+e+g(n)+">","</"+e+">")},"XML"===(null==(r=t.state.source)?void 0:r.type)&&(l("keydown",e,h),l("keyup",e,w),l("mousedown",e,m),l("touchstart",e,b)),t},detach:function(e){return a("keydown",e,h),a("keyup",e,w),a("mousedown",e,m),a("touchstart",e,b),$}}}));