/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return e&&o(r)&&e instanceof r},i=function(e){return c(e)&&0==e%1},c=function(e){return"number"==typeof e},o=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},f=function(e){return e.length},u=function(e){return Object.keys(e)},s=function(e,r){return void 0===r&&(r=""),e.replace(a("["+r+l.replace(/./g,"\\$&")+"]"),"\\$&")},a=function(e,r){return function(e){return n(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,o(r)?r:"g"))},l="!$^*()+=[]{}|:<>,.?/-",d=function(e,r){return-1!==r.indexOf(e)},p=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},v=function e(r){if(function(e){return Array.isArray(e)}(r))return r.map((function(t){return e(r)}));if(function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||n(e,Object))}(r)){for(var t in r)r[t]=e(r[t]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},x=function(e){return e&&e.preventDefault()},$=function(){return"[\\w:.-]+"},b=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},m=function(e){return"</("+e+")>"},h=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+m($())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+$()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+b($())+")"},w=(e=function(e,r){var t=r.$(),n=t.after,i=t.before,c=t.end,o=t.value;if(!o)for(var u,s,l="\ufeff",p=h().split("("+$()+")").join("((?:"+$()+"|\ufeff)+)"),v=a(p),b=i+o+l+n;u=v.exec(b);)if(d(l,u[0])){x(e);var m=u[0].split(l);if(">"===m[1]||"/>"===(m[1]||"").trim()){r.select(s=u.index,s+f(u[0])-1);break}if("<"!==m[0]&&"</"!==m[0]&&!/\s/.test(m[0])){r.select(s=u.index+("/"===m[0][1]?2:1),c+f(m[1].split(/[\s\/>]/).shift()));break}var w=void 0;if(w=a("=(\"[^\"]*\ufeff[^\"]*\"|'[^']*\ufeff[^']*')").exec(u[0])){r.select(s=u.index+w.index+2,s+f(w[1])-3);break}if(w=a("=([^\"'\\s\\/>]*\ufeff[^\"'\\s\\/>]*)").exec(u[0])){r.select(s=u.index+w.index+1,s+f(w[1])-1);break}if("<"!==m[0]&&"</"!==m[0]&&(w=a("([^=\"'\\s]*\ufeff[^=\"'\\s]*)[=\\s\\/>]").exec(u[0]))){r.select(s=u.index+w.index,s+f(w[1])-1);break}r.select(s=u.index,s+f(u[0])-1);break}},r=1,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function g(e){var r,t=this,n=t.k(!1).pop(),c=t.k();if(t&&!e.defaultPrevented&&!t.keys[c]&&"Alt"!==c&&"Control"!==c){var o=t.$(),u=o.after,l=o.before;o.end;var d=o.start,p=o.value;if(["-",">","/","?"," "].includes(n)){if("-"===n)return p||"<!-"!==l.slice(-3)?void 0:(x(e),t.wrap("- "," --"+(">"===u[0]?"":">")).record());if(">"===n||"/"===n){var v=a(b($())+"$","").exec(l+">");if(!p&&v){if(x(e),"/"===n)return">"===u[0]?t.trim("",!1).insert(" /",-1).select(t.$().start+1).record():t.trim("",!1).insert(" />",-1).record();u.startsWith("></"+v[1]+">")?t.select(d+1).record():u.startsWith("</"+v[1]+">")?t.insert(">",-1).record():t.wrap(">","</"+v[1]+(">"===u[0]?"":">")).record()}return}return"?"===n?p||"<"!==l.slice(-1)?void 0:(x(e),t.wrap("?","?"+(">"===u[0]?"":">")).record()):" "===n&&!p&&("--\x3e"===u.slice(0,3)&&"\x3c!--"===l.slice(-4)||"?>"===u.slice(0,2)&&"<?"===l.slice(0,2)&&/<\?\S*$/.test(l))?(x(e),t.wrap(" "," ").record()):void 0}var w=t.$();if(u=w.after,l=w.before,w.end,d=w.start,p=w.value,"ArrowLeft"!==c){if("ArrowRight"!==c){var g=(null==(r=t.state.source)?void 0:r.tab)||t.state.tab||"\t",k=l.split("\n").pop().match(/^(\s+)/),y=k&&k[1]||"";if(i(g)&&(g=" ".repeat(g)),"Enter"!==c){if("Backspace"!==c){if("Delete"===c&&!p){if("--\x3e"===u.slice(0,3))return x(e),t.replace(/^-->/,"",1).record();if("?>"===u.slice(0,2))return x(e),t.replace(/^\?>/,"",1).record();var L=a("^"+h(),"");if(L.exec(u))return x(e),t.replace(L,"",1).record()}}else if(!p){if("\x3c!--"===l.slice(-4))return x(e),t.replace(/<!--$/,"",-1),"--\x3e"===u.slice(0,3)&&t.replace(/^-->/,"",1),t.record();if(/^\s+-->/.test(u)&&/<!--\s+$/.test(l))return x(e),t.trim(" "===l.slice(-1)?"":" "," "===u[0]?"":" ").record();if(/<\?\S*$/.test(l))return x(e),t.replace(/<\?\S*$/,"",-1),"?>"===u.slice(0,2)&&t.replace(/^\?>/,"",1),t.record();if(/^\s+\?>/.test(u)&&/<\?\S*\s+$/.test(l))return x(e),t.trim(" "===l.slice(-1)?"":" "," "===u[0]?"":" ").record();var M=a(h()+"$",""),S=M.exec(l);if(S){if(x(e)," />"===l.slice(-3))return t.replace(/ \/>$/,"/>",-1).record();if("/>"===l.slice(-2))return t.replace(/\/>$/,">",-1).record();t.replace(M,"",-1);var T=S[0].slice(1).split(/\s+|>/)[0];return S[0]&&"/"!==S[0][1]&&u.startsWith("</"+T+">")&&t.replace(a("^</"+T+">",""),"",1),t.record()}if(a(b($())+"\\n(?:"+s(g)+")?$","").test(l)&&a("^\\s*"+m($()),"").test(u))return x(e),t.trim().record()}}else{var X=l.match(a(b($())+"$",""));if(!p){if(X)return x(e),u.startsWith("</"+X[1]+">")?t.record().trim().wrap("\n"+y+g,"\n"+y).record():t.record().wrap("\n"+y+g,"\n"+y+"</"+X[1]+">").record();if(/^[ \t]*-->/.test(u)&&/<!--[ \t]*$/.test(l)||/^[ \t]*\?>/.test(u)&&/<\?\S*[ \t]*$/.test(l))return x(e),t.trim().wrap("\n"+y,"\n"+y).record()}}}else if(!p){var E=a("^"+h(),"").exec(u);if(E)return x(e),t.select(d,d+f(E[0]))}}else if(!p){var j=a(h()+"$","").exec(l);if(j)return x(e),t.select(d-f(j[0]),d)}}}function k(e){var r=this;r.k(!1).pop();var t=r.k();r&&!e.defaultPrevented&&(t.startsWith("Control-")||w(e,r))}function y(e){if(!e)return"";e=u(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+p(v(t),!0)+'"'));return n}return{attach:function(){var e,r=this;return r.insertXML=function(e,t,n,c){if(void 0===t&&(t=""),void 0===n&&(n={}),void 0===c&&(c=!1),c){var o,f=r.$(),u=f.after,s=f.before,l=(null==(o=r.state.source)?void 0:o.tab)||r.state.tab||"\t";if(i(l)&&(l=" ".repeat(l)),a("^"+m($()),"").test(u)&&a(b($())+"$","").test(s)){var d=s.split("\n").pop().match(/^(\s+)/),p=d&&d[1]||"";r.wrap("\n"+l+p,"\n"+p)}}return r.insert("<"+e+y(n)+(!1!==t?">"+t+"</"+e+">":" />"),-1,!0)},r.peelXML=function(e,t,n,i){return void 0===i&&(i=!1),i&&r.trim("",""),r.replace(a(b(e)+"$",""),"",-1).replace(a("^"+m(e)),"",1)},r.toggleXML=function(e,t,n,i){void 0===t&&(t=""),void 0===n&&(n={}),void 0===i&&(i=!1);var c=r.$(),o=c.after,f=c.before,u=b(e),s=m(e),l=a(u+"$",""),d=a("^"+s,""),p=l.test(f),v=d.test(o);return r[(p&&v?"peel":"wrap")+"XML"](e,t,n,i)},r.wrapXML=function(e,t,n,c){void 0===t&&(t=""),void 0===n&&(n={}),void 0===c&&(c=!1);var o=r.$(),f=o.after,u=o.before;if(!o.value&&t&&r.insert(t),c){var s,l=(null==(s=r.state.source)?void 0:s.tab)||r.state.tab||"\t";if(i(l)&&(l=" ".repeat(l)),a("^"+m($()),"").test(f)&&a(b($())+"$","").test(u)){var d=u.split("\n").pop().match(/^(\s+)/),p=d&&d[1]||"";r.wrap("\n"+l+p,"\n"+p)}}return r.wrap("<"+e+y(n)+">","</"+e+">")},"XML"===(null==(e=r.state.source)?void 0:e.type)&&(r.on("key.down",g),r.on("mouse.down",k)),r},detach:function(){var e=this;return e.off("key.down",g),e.off("mouse.down",k),e}}}));