/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2022 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceXML={}))}(this,(function(e){"use strict";var r=function(e,r){return-1!==r.indexOf(e)},t=function(e){return Array.isArray(e)},n=function(e,r){return e&&i(r)&&e instanceof r},i=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return e.length},u=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")},s=function e(r){if(t(r))return r.map((function(t){return e(r)}));if(function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||n(e,Object))}(r)){for(var i in r)r[i]=e(r[i]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},f=window,o=function(e,r){return function(e){return n(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,i(r)?r:"g"))},l="!$^*()+=[]{}|:<>,.?/-";let a="[\\w:.-]+",p=e=>"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",d=e=>"</("+e+")>",$="(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+d(a)+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+p(a)+"|"+("<("+a+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>)");const x={};function w(e){if(!e)return"";e=function(e){return Object.keys(e)}(e).sort().reduce(((r,t)=>(r[t]=e[t],r)),{});let r,t,n="";for(r in e)t=e[r],!1!==t&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+u(s(t))+'"'));return n}function b(e){return!1!==e&&(!function(e){return"string"==typeof e}(e)?t(e)||(e=["",""]):e=[e,e],i(e[1])||(e[1]=e[0])),e}x.insert=function(e,r="",t={},n=!1){let i=this;return!1!==(n=b(n))&&i.trim(n[0],""),i.insert("<"+e+w(t)+(!1!==r?">"+r+"</"+e+">":" />")+(!1!==n?n[1]:""),-1,!0)},x.toggle=function(e,r="",t={},n=!1){let i=this,{after:c,before:u,value:s}=i.$(),f=p(e),l=d(e),a=o(f+"$",""),$=o("^"+l,""),x=a.test(u),m=$.test(c);return m&&x?i.replace($,"",1).replace(a,"",-1):(a=o("^"+f,""),$=o(l+"$",""),x=a.test(s),m=$.test(s),m&&x&&i.insert(s=s.replace($,"").replace(a,"")),!s&&r&&i.insert(r),!1!==(n=b(n))&&i.trim(n[0],n[1]),i.wrap("<"+e+w(t)+">","</"+e+">"))},x.wrap=function(e,r="",t={},n=!1){let i=this,{after:c,before:u,value:s}=i.$();return!s&&r&&i.insert(r),!1!==(n=b(n))&&i.trim(n[0],n[1]),i.wrap("<"+e+w(t)+">","</"+e+">")};const m={source:{type:"XML"},sourceXML:{}};e.canKeyDown=function(e,r){let t=r.state,n=t.sourceXML.tab||t.tab||"\t",{key:i,queue:u}=e,s=e+"";if(u.Alt||u.Control)return!0;if(["-",">","/","?"," "].includes(i)){let{after:e,before:t,value:n,start:c}=r.$();if("-"===i&&!n&&"<!-"===t.slice(-3))return r.wrap("- "," --"+(">"===e[0]?"":">")).record(),!1;if(">"===i||"/"===i){let u=o(p(a)+"$","").exec(t+">");if(!n&&u)return"/"===i?">"===e[0]?(r.trim("",!1).insert(" /",-1).select(r.$().start+1).record(),!1):(r.trim("",!1).insert(" />",-1).record(),!1):(e.startsWith("></"+u[1]+">")?r.select(c+1).record():e.startsWith("</"+u[1]+">")?r.insert(">",-1).record():r.wrap(">","</"+u[1]+(">"===e[0]?"":">")).record(),!1)}if("?"===i&&!n&&"<"===t.slice(-1))return r.wrap("?","?"+(">"===e[0]?"":">")).record(),!1;if(" "===s&&!n&&("--\x3e"===e.slice(0,3)&&"\x3c!--"===t.slice(-4)||"?>"===e.slice(0,2)&&"<?"===t.slice(0,2)&&/<\?\S*$/.test(t)))return r.wrap(" "," ").record(),!1}if("ArrowLeft"===s){let{before:e,start:t,value:n}=r.$();if(!n){let n=o($+"$","").exec(e);if(n)return r.select(t-c(n[0]),t),!1}}if("ArrowRight"===s){let{after:e,start:t,value:n}=r.$();if(!n){let n=o("^"+$,"").exec(e);if(n)return r.select(t,t+c(n[0])),!1}}if("Enter"===s){let{after:e,before:t,value:i}=r.$(),c=t.split("\n").pop().match(/^(\s+)/),u=c&&c[1]||"",s=t.match(o(p(a)+"$",""));if(!i){if(/^[ \t]*-->/.test(e)&&/<!--[ \t]*$/.test(t)||/^[ \t]*\?>/.test(e)&&/<\?\S*[ \t]*$/.test(t))return r.trim().wrap("\n"+u,"\n"+u).record(),!1;if(s)return e.startsWith("</"+s[1]+">")?r.record().trim().wrap("\n"+u+n,"\n"+u).record():r.record().wrap("\n"+u+n,"\n"+u+"</"+s[1]+">").record(),!1}}if("Backspace"===s){let{after:e,before:t,value:i}=r.$();if(!i){if("\x3c!--"===t.slice(-4))return r.replace(/<!--$/,"",-1),"--\x3e"===e.slice(0,3)&&r.replace(/^-->/,"",1),r.record(),!1;if(/^\s+-->/.test(e)&&/<!--\s+$/.test(t))return r.trim(" "===t.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;if(/<\?\S*$/.test(t))return r.replace(/<\?\S*$/,"",-1),"?>"===e.slice(0,2)&&r.replace(/^\?>/,"",1),r.record(),!1;if(/^\s+\?>/.test(e)&&/<\?\S*\s+$/.test(t))return r.trim(" "===t.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;let i=o($+"$",""),c=i.exec(t);if(c){if(" />"===t.slice(-3))return r.replace(/ \/>$/,"/>",-1).record(),!1;if("/>"===t.slice(-2))return r.replace(/\/>$/,">",-1).record(),!1;r.replace(i,"",-1);let n=c[0].slice(1).split(/\s+|>/)[0];return c[0]&&"/"!==c[0][1]&&e.startsWith("</"+n+">")&&r.replace(o("^</"+n+">",""),"",1),r.record(),!1}if(o(p(a)+"\\n(?:"+(f=n,void 0===x&&(x=""),f.replace(o("["+x+l.replace(/./g,"\\$&")+"]"),"\\$&")+")?$"),"").test(t)&&o("^\\s*"+d(a),"").test(e))return r.trim().record(),!1}}var f,x;if("Delete"===s){let{after:e,value:t}=r.$();if(!t){if("--\x3e"===e.slice(0,3))return r.replace(/^-->/,"",1).record(),!1;if("?>"===e.slice(0,2))return r.replace(/^\?>/,"",1).record(),!1;let t=o("^"+$,"");if(t.exec(e))return r.replace(t,"",1).record(),!1}}return!0},e.canMouseDown=function(e,t){let{key:n,queue:i}=e;return i.Control||f.setTimeout((()=>{let{after:e,before:n,value:i}=t.$();if(!i){let u,s,f="\ufeff",l=$.split("([\\w:.-]+)").join("((?:[\\w:.-]|"+f+")+)"),a=o(l),p=n+i+f+e;for(;u=a.exec(p);)if(r(f,u[0])){t.select(s=u.index,s+c(u[0])-1);break}}}),1),!0},e.state=m,e.that=x,e.toAttributes=w}));