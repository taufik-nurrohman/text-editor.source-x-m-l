/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman
 *
 * <https://github.com/taufik-nurrohman/text-editor.source-x-m-l>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceXML=r())}(this,(function(){"use strict";var e=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},r=function(e){return e.length},t=function(r){return function(r,t){return r&&e(t)&&r instanceof t}(r,RegExp)},c=function(r,c){return t(r)?r:(r=r.replace(/\//g,"\\/"),RegExp(r,e(c)?c:"g"))},i="!$^*()+=[]{}|:<>,.?/-";let n="\x3c!--([\\s\\S]*?)--\x3e",l="<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>",f="<([\\w:.-]+)(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",o="</([\\w:.-]+)>",s="<([\\w:.-]+)(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>",u="<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>";return{canKeyDown:function(e,{a:t,c:a,s:d},p){let $=p.state.tab||"\t";if(t||a)return!0;if(["-",">","/","?"," "].includes(e)){let{after:t,before:i,value:n,start:l}=p.$();if("-"===e&&!n&&"<!-"===i.slice(-3))return p.wrap("- "," --"+(">"===t[0]?"":">")).record(),!1;if(">"===e||"/"===e){let o=c(f+"$","").exec(i+">");if(!n&&o)return"/"===e?">"===t[0]?(p.trim().insert(" /",-1).select(l+3).record(),!1):(p.trim().insert(" />",-1).record(),!1):("></"+o[1]+">"===t.slice(0,r(o[1])+4)?p.select(l+1).record():"</"+o[1]+">"===t.slice(0,r(o[1])+3)?p.insert(">",-1).record():p.wrap(">","</"+o[1]+(">"===t[0]?"":">")).record(),!1)}if("?"===e&&!n&&"<"===i.slice(-1))return p.wrap("?","?"+(">"===t[0]?"":">")).record(),!1;if(" "===e&&!n&&"\x3c!--"===i.slice(-4)&&"--\x3e"===t.slice(0,3))return p.wrap(" "," ").record(),!1}if("ArrowLeft"===e&&!d){let{before:e,start:r,value:t}=p.$();if(!t){let t=c("(?:"+n+"|"+l+"|"+o+"|"+u+"|"+f+"|"+s+")$","").exec(e);if(t)return p.select(t.index,r),!1}}if("ArrowRight"===e&&!d){let{after:e,start:t,value:i}=p.$();if(!i){let i=c("^(?:"+n+"|"+l+"|"+o+"|"+u+"|"+f+"|"+s+")","").exec(e);if(i)return p.select(t,t+r(i[0])),!1}}if("Enter"===e&&!d){let{after:e,before:r,value:t}=p.$(),i=r.split("\n").pop().match(/^(\s+)/),n=i&&i[1]||"",l=r.match(c(f+"$",""));if(!t&&/^[ \t]*-->/.test(e)&&/<!--[ \t]*$/.test(r))return p.trim().wrap("\n\n"+n,"\n\n"+n).record(),!1;if(!t&&l)return c("^</"+l[1]+">","").test(e)?p.record().trim().wrap("\n"+n+$,"\n"+n).record():p.record().wrap("\n"+n+$,"\n"+n+"</"+l[1]+">").record(),!1}if("Backspace"===e&&!d){let{after:e,before:t,value:a}=p.$();if(!a){if("\x3c!--"===t.slice(-4))return p.replace(/<!--$/,"",-1),"--\x3e"===e.slice(0,3)&&p.replace(/^-->/,"",1),p.record(),!1;if(/^\s+-->/.test(e)&&/<!--\s+$/.test(t))return p.trim(" "===t.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;if("<?"===t.slice(-2))return p.replace(/<\?$/,"",-1),"?>"===e.slice(0,2)&&p.replace(/^\?>/,"",1),p.record(),!1;let a=c("(?:"+n+"|"+l+"|"+o+"|"+u+"|"+f+"|"+s+")$",""),d=a.exec(t);if(d){p.replace(a,"",-1);let t=d[0].slice(1).split(/\s+|>/)[0];return d[0]&&"/"!==d[0][1]&&"</"+t+">"===e.slice(0,r(t)+3)&&p.replace(c("^</"+t+">",""),"",1),p.record(),!1}if(c(f+"\\n(?:"+(x=$,void 0===w&&(w=""),x.replace(c("["+w+i.replace(/./g,"\\$&")+"]"),"\\$&")+")?$"),"").test(t)&&c("^\\s*"+o,"").test(e))return p.trim().record(),!1}}var x,w;if("Delete"===e&&!d){let{after:e,value:r}=p.$();if(!r){if("--\x3e"===e.slice(0,3))return p.replace(/^-->/,"",1).record(),!1;if("?>"===e.slice(0,2))return p.replace(/^\?>/,"",1).record(),!1;let r=c("^(?:"+n+"|"+l+"|"+o+"|"+u+"|"+f+"|"+s+")","");if(r.exec(e))return p.replace(r,"",1).record(),!1}}return!0}}}));