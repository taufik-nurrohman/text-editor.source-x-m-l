/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=t())}(this,(function(){"use strict";var e=function(e){return Array.isArray(e)},t=function(e,t){return e&&s(t)&&e instanceof t},r=function(e){return n(e)&&0==e%1},n=function(e){return"number"==typeof e},i=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||t(e,Object))},s=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return e.length},l=function(e){return Object.keys(e)},a=function(e,r){return function(e){return t(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,s(r)?r:"g"))},o=function(e,t){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),t&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},u=function t(){for(var r=arguments.length,n=Array(r),l=0;l<r;l++)n[l]=arguments[l];for(var a,o=n.shift(),u=0,f=c(n);u<f;++u)for(var p in n[u])if(s(o[p]))if(e(o[p])&&e(n[u][p])){o[p]=[].concat(o[p]);for(var d=0,m=c(n[u][p]);d<m;++d)a=n[u][p][d],-1===o[p].indexOf(a)&&o[p].push(n[u][p][d])}else i(o[p])&&i(n[u][p])?o[p]=t({},o[p],n[u][p]):o[p]=n[u][p];else o[p]=n[u][p];return o},f=function t(r){if(e(r))return r.map((function(e){return t(r)}));if(i(r)){for(var n in r)r[n]=t(r[n]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},p=function(e){return e&&e.preventDefault()},d=function(e){return"</("+e+")>"},m=function(){return"[\\w:.-]+"},$=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+d(m())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+m()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+$(m())+")"};function A(e){var t,n,i=this,l=i.k(!1).pop(),o=i.k();if(!e.defaultPrevented&&!i.keys[o]&&"Alt"!==o&&"Control"!==o){var u=i.$(),f=u.after,A=u.before;u.end;var x=u.start,D=u.value,C=(null==(t=i.state.source)?void 0:t.tab)||i.state.tab||"\t",g=i.state.elements||{},T=/^\s+/.exec(A.split("\n").pop()),h=T&&T[0]||"";if(r(C)&&(C=" ".repeat(C)),D){if("Backspace"===o)return"<![CDATA["===A.slice(-9)&&"]]>"===f.slice(0,3)&&D===g["#data"]?(p(e),i.insert("").record()):void 0;if("Delete"===o)return"<![CDATA["===A.slice(-9)&&"]]>"===f.slice(0,3)&&D===g["#data"]?(p(e),i.insert("").record()):void 0;if("Enter"===o){if("\x3c!-- "===A.slice(-5)&&" --\x3e"===f.slice(0,4)&&D===g["#comment"])return p(e),i.trim("\n"+h,"\n"+h).insert("").record();if("<![CDATA["===A.slice(-9)&&"]]>"===f.slice(0,3)&&D===g["#data"])return p(e),i.trim("\n"+h,"\n"+h).insert("").record();if((n=a($(m())+"$","").exec(A))&&f.startsWith("</"+n[1]+">")&&s(g[n[1]])&&D===g[n[1]][1])return p(e),i.trim("\n"+h+C,"\n"+h).insert("").record()}}else{if("-"===l)return"<!-"===A.slice(-3)?(p(e),i.insert(g["#comment"]||"").wrap("- "," --"+(">"===f[0]?"":">")).record()):void 0;if(">"===l||"/"===l){if(!(n=a($(m())+"$","").exec(A+">")))return;return p(e),"/"===l?">"===f[0]?i.trim("",!1).insert(" /",-1).select(i.$().start+1).record():i.trim("",!1).insert(" />",-1).record():s(g[n[1]])?!1===(D=g[n[1]][1])?">"===f[0]?i.trim("",!1).insert(" /",-1).select(i.$().start+1).record():i.trim("",!1).insert(" />",-1).record():(D&&i.insert(D),i.wrap(">","</"+n[1]+(">"===f[0]?"":">")).record()):f.startsWith("></"+n[1]+">")?i.select(x+1).record():f.startsWith("</"+n[1]+">")?i.insert(">",-1).record():i.wrap(">","</"+n[1]+(">"===f[0]?"":">")).record()}if("?"===l)return"<"===A.slice(-1)?(p(e),i.wrap("?","?"+(">"===f[0]?"":">")).record()):void 0;if("["===l)return"<![CDATA"===A.slice(-8)&&"]>"===f.slice(0,2)?i.insert(g["#data"]||""):void 0;if(" "===l)return"--\x3e"===f.slice(0,3)&&"\x3c!--"===A.slice(-4)||"?>"===f.slice(0,2)&&/<\?\S*$/.test(A)?(p(e),"?>"===f.slice(0,2)&&i.insert(g["#instruction"]||""),i.wrap(" "," ").record()):void 0;var w=i.$();if(f=w.after,A=w.before,w.end,x=w.start,!(D=w.value)){if("ArrowLeft"===o&&(n=a(v()+"$","").exec(A)))return p(e),i.select(x-c(n[0]),x);if("ArrowRight"===o&&(n=a("^"+v(),"").exec(f)))return p(e),i.select(x,x+c(n[0]));if(h=(T=/^\s+/.exec(A.split("\n").pop()))&&T[0]||"","Backspace"===o){if("\x3c!--"===A.slice(-4))return p(e),i.replace(/<!--$/,"",-1),"--\x3e"===f.slice(0,3)&&i.replace(/^-->/,"",1),i.record();if(/^(\n[ \t]*){2,}-->/.test(f)&&/<!--(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+h,"\n"+h).record();if(/^\s+-->/.test(f)&&/<!--\s+$/.test(A)){p(e);var b=f[0],S=A.slice(-1),E=" "===b&&" "===S?"":" ";return i.trim(E,E).record()}if("<![CDATA["===A.slice(-9))return p(e),i.replace(/<!\[CDATA\[$/,"",-1),"]]>"===f.slice(0,3)&&i.replace(/^\]\]>/,"",1),i.record();if(/<\?\S*$/.test(A))return p(e),i.replace(/<\?\S*$/,"",-1),"?>"===f.slice(0,2)&&i.replace(/^\?>/,"",1),i.record();if(/^(\n[ \t]*){2,}\?>/.test(f)&&/<\?\S*(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+h,"\n"+h).record();if(/^\s+\?>/.test(f)&&/<\?\S*\s+$/.test(A)){p(e);var y=f[0],k=A.slice(-1),I=" "===y&&" "===k?"":" ";return i.trim(I,I).record()}if("<![CDATA["===A.slice(-9))return p(e),i.replace(/<!\[CDATA\[$/,"",-1),"]]>"===f.slice(0,3)&&i.replace(/^\]\]>/,"",1),i.record();if(/^(\n[ \t]*){2,}\]\]>/.test(f)&&/<!\[CDATA\[(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+h,"\n"+h).record();if(/^\s+\]\]>/.test(f)&&/<!\[CDATA\[\s+$/.test(A)){p(e);var W=f[0],j=A.slice(-1),O=" "===W&&" "===j?"":" ";return i.trim(O,O).record()}var R=a(v()+"$",""),B=R.exec(A);if(B){if(p(e)," />"===A.slice(-3))return i.replace(/ \/>$/,"/>",-1).record();if("/>"===A.slice(-2))return i.replace(/\/>$/,">",-1).record();i.replace(R,"",-1);var L=B[0].slice(1).split(/\s+|>/)[0];return B[0]&&"/"!==B[0][1]&&f.startsWith("</"+L+">")&&i.replace(a("^</"+L+">",""),"",1),i.record()}if(a("(^|\\n)([ \\t]*)"+$(m())+"\\n\\2$","").test(A)&&a("^\\s*"+d(m()),"").test(f))return p(e),i.trim().record()}if("Delete"===o){if("--\x3e"===f.slice(0,3))return p(e),i.replace(/^-->/,"",1).record();if("]]>"===f.slice(0,3))return p(e),i.replace(/^\]\]>/,"",1).record();if("?>"===f.slice(0,2))return p(e),i.replace(/^\?>/,"",1).record();var q=a("^"+v(),"");if(q.exec(f))return p(e),i.replace(q,"",1).record()}if("Enter"===o){if(/^[ \t]*-->/.test(f)&&/<!--[ \t]*$/.test(A)||/^[ \t]*\?>/.test(f)&&/<\?\S*[ \t]*$/.test(A)||/^[ \t]*\]\]>/.test(f)&&/<!\[CDATA\[[ \t]*$/.test(A))return p(e),i.trim("\n"+h,"\n"+h).record();if(/^(\n[ \t]*)-->/.test(f)&&/<!--(\n[ \t]*)$/.test(A)||/^(\n[ \t]*)\?>/.test(f)&&/<\?\S*(\n[ \t]*)$/.test(A)||/^(\n[ \t]*)\]\]>/.test(f)&&/<!\[CDATA\[(\n[ \t]*)$/.test(A))return p(e),i.trim("\n\n"+h,"\n\n"+h).record();if(n=a($(m())+"$","").exec(A))return p(e),f.startsWith("</"+n[1]+">")?i.record().trim("\n"+h+C,"\n"+h).record():i.record().wrap("\n"+h+C,"\n"+h+"</"+n[1]+">").record()}}}}}function x(e){if(!e)return"";e=l(e).sort().reduce((function(t,r){return t[r]=e[r],t}),{});var t,r,n="";for(t in e)!1!==(r=e[t])&&null!==r&&(n+=" "+t,!0!==r&&(n+='="'+o(f(r),!0)+'"'));return n}return{attach:function(){var t,r=this,n=/^\s*([\s\S]*?)\s*$/,i=/^<!--\s*([\s\S]*?)\s*-->$/,l=/^<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>$/,o=/^<\?\S*\s*([\s\S]*?)\s*\?>$/;return r.state=t=u({elements:{"#comment":"Comment goes here…","#data":"Data goes here…","#instruction":"Instruction goes here…"}},r.state),r.insertComment=function(e,n,i){return r.insert("\x3c!--"+(e||t.elements["#comment"]||"")+"--\x3e",s(n)?n:-1,!s(i)||i)},r.insertData=function(e,n,i){return r.insert("<![CDATA["+(e||t.elements["#data"]||"")+"]]>",s(n)?n:-1,!s(i)||i)},r.insertElement=function(n,i,c){if(e(n)){var l;if(s(t.elements[n[0]]))n[1]=null!=(l=n[1])?l:t.elements[n[0]][1],n[2]=u({},t.elements[n[0]][2]||{},n[2]||{});n="<"+n[0]+x(n[2])+(!1===n[1]?" />":">"+(n[1]||"")+"</"+n[0]+">")}return r.insert(n,s(i)?i:-1,!s(c)||c)},r.insertInstruction=function(e,n,i,c){return r.insert("<?"+(c||"")+(e||t.elements["#instruction"]||"")+"?>",s(n)?n:-1,!s(i)||i)},r.peelComment=function(e){return e?r.replace(i,"$1"):r.replace(/<!--\s*$/,"",-1).replace(/^\s*-->/,"",1)},r.peelData=function(e){return e?r.replace(l,"$1"):r.replace(/<!\[CDATA\[\s*$/,"",-1).replace(/^\s*\]\]>/,"",1)},r.peelElement=function(n,i,c){if(e(n)){var l;if(s(t.elements[n[0]]))n[1]=null!=(l=n[1])?l:t.elements[n[0]][1],n[2]=u({},t.elements[n[0]][2]||{},n[2]||{});return(c=i)?r.replace(a("^"+$(n[0])+"([\\s\\S]*?)"+d(n[0])+"$",""),"$3"):r.replace(a($(n[0])+"$",""),"",-1).replace(a("^"+d(n[0])),"",1)}return r.peel(n,i,c)},r.peelInstruction=function(e){return e?r.replace(o,"$1"):r.replace(/<\?\S*\s*$/,"",-1).replace(/^\s*\?>/,"",1)},r.selectComment=function(e){for(var t=r.$(),n=t.after,i=t.before,s=t.end,l=t.start,a=t.value;i&&"\x3c!--"!==a.slice(0,4);)a=i.slice(-1)+a,i=i.slice(0,-1),l-=1;for(;n&&"--\x3e"!==a.slice(-3);)a+=n.slice(0,1),n=n.slice(1),s+=1;if(!e){var o=a.slice(4,-3),u=/\s+$/.exec(o),f=/^\s+/.exec(o);u&&(s-=3+c(u[0])),f&&(l+=4+c(f[0]))}return"\x3c!--"===a.slice(0,4)&&"--\x3e"===a.slice(-3)?r.select(l,s):r.select()},r.selectData=function(e){for(var t=r.$(),n=t.after,i=t.before,s=t.end,l=t.start,a=t.value;i&&"<![CDATA["!==a.slice(0,9);)a=i.slice(-1)+a,i=i.slice(0,-1),l-=1;for(;n&&"]]>"!==a.slice(-3);)a+=n.slice(0,1),n=n.slice(1),s+=1;if(!e){var o=a.slice(9,-3),u=/\s+$/.exec(o),f=/^\s+/.exec(o);u&&(s-=3+c(u[0])),f&&(l+=9+c(f[0]))}return"<![CDATA["===a.slice(0,9)&&"]]>"===a.slice(-3)?r.select(l,s):r.select()},r.selectElement=function(e){var t=r.$();t.after,t.before,t.end,t.start,t.value},r.selectInstruction=function(e,t){for(var n=r.$(),i=n.after,l=n.before,a=n.end,o=n.start,u=n.value;l&&"<?"!==u.slice(0,2);)u=l.slice(-1)+u,l=l.slice(0,-1),o-=1;for(;i&&"?>"!==u.slice(-2);)u+=i.slice(0,1),i=i.slice(1),a+=1;if(s(t)||(t=u.slice(2).split(/\s+/).shift()),!e){var f=u.slice(2+(t?c(t):0),-2),p=/\s+$/.exec(f),d=/^\s+/.exec(f);p&&(a-=2+c(p[0])),d&&(o+=2+(t?c(t):0)+c(d[0]))}return"<?"===u.slice(0,2)&&"?>"===u.slice(-2)?r.select(o,a):r.select()},r.toggleComment=function(e){var t=r.$(),n=t.after,s=t.before,c=t.value;return e?r[(i.test(c)?"peel":"wrap")+"Comment"](e):r[(/<!--\s*$/.test(s)&&/^\s*-->/.test(n)?"peel":"wrap")+"Comment"](e)},r.toggleData=function(e){var t=r.$(),n=t.after,i=t.before,s=t.value;return e?r[(l.test(s)?"peel":"wrap")+"Data"](e):r[(/<!\[CDATA\[\s*$/.test(i)&&/^\s*\]\]>/.test(n)?"peel":"wrap")+"Data"](e)},r.toggleElement=function(n,i,c){if(e(n)){var l;if(s(t.elements[n[0]]))n[1]=null!=(l=n[1])?l:t.elements[n[0]][1],n[2]=u({},t.elements[n[0]][2]||{},n[2]||{});c=i;var o=r.$(),f=o.after,p=o.before,m=o.value,v=$(n[0]),A=d(n[0]);return c?r[(a("^"+v+"[\\s\\S]*?"+A+"$","").test(m)?"peel":"wrap")+"Element"](n,i,c):r[(a(v+"$","").test(p)&&a("^"+A,"").test(f)?"peel":"wrap")+"Element"](n,i,c)}return r.toggle(n,i,c)},r.toggleInstruction=function(e,t){},r.wrapComment=function(e){var i=r.$().value,s=t.elements["#comment"]||"";return!i&&s&&r.insert(s),e?r.replace(n,"\x3c!--$1--\x3e"):r.trim(!1,!1).replace(/$/,"\x3c!--",-1).replace(/^/,"--\x3e",1)},r.wrapData=function(e){var i=r.$().value,s=t.elements["#data"]||"";return!i&&s&&r.insert(s),e?r.replace(n,"<![CDATA[$1]]>"):r.trim(!1,!1).replace(/$/,"<![CDATA[",-1).replace(/^/,"]]>",1)},r.wrapElement=function(i,c,l){if(e(i)){var a;if(s(t.elements[i[0]]))i[1]=null!=(a=i[1])?a:t.elements[i[0]][1],i[2]=u({},t.elements[i[0]][2]||{},i[2]||{});l=c;var o=r.$().value;return l?r.replace(n,"<"+i[0]+x(i[2])+">"+(o||i[1]||"").trim()+"</"+i[0]+">"):r.trim(!1,!1).replace(/$/,"<"+i[0]+x(i[2])+">",-1).replace(/^/,"</"+i[0]+">",1).insert(o||i[1]||"")}return r.wrap(i,c,l)},r.wrapInstruction=function(e,t){},r.on("key.down",A)},detach:function(){return this.off("key.down",A)}}}));