/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return e&&i(r)&&e instanceof r},i=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return e.length},o=function(e){return Object.keys(e)},f=function(e,r){return void 0===r&&(r=""),e.replace(s("["+r+u.replace(/./g,"\\$&")+"]"),"\\$&")},s=function(e,r){return function(e){return n(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,i(r)?r:"g"))},u="!$^*()+=[]{}|:<>,.?/-",a=function(e,r){return-1!==r.indexOf(e)},l=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},d=function e(r){if(function(e){return Array.isArray(e)}(r))return r.map((function(t){return e(r)}));if(function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||n(e,Object))}(r)){for(var t in r)r[t]=e(r[t]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},p=function(e,r,t){r.removeEventListener(e,t)},v=function(e){return e&&e.preventDefault()},x=function(e,r,t,n){void 0===n&&(n=!1),r.addEventListener(e,t,n)},b=function(){return"[\\w:.-]+"},h=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},m=function(e){return"</("+e+")>"},w=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+m(b())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+b()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+h(b())+")"},g=(e=function(e,r){var t=r.$(),n=t.after,i=t.before,o=t.end,f=t.value;if(!f)for(var u,l,d="\ufeff",p=w().split("("+b()+")").join("((?:"+b()+"|\ufeff)+)"),x=s(p),$=i+f+d+n;u=x.exec($);)if(a(d,u[0])){v(e);var h=u[0].split(d);if(">"===h[1]||"/>"===(h[1]||"").trim()){r.select(l=u.index,l+c(u[0])-1);break}if("<"!==h[0]&&"</"!==h[0]&&!/\s/.test(h[0])){r.select(l=u.index+("/"===h[0][1]?2:1),o+c(h[1].split(/[\s\/>]/).shift()));break}var m=void 0;if(m=s("=(\"[^\"]*\ufeff[^\"]*\"|'[^']*\ufeff[^']*')").exec(u[0])){r.select(l=u.index+m.index+2,l+c(m[1])-3);break}if(m=s("=([^\"'\\s\\/>]*\ufeff[^\"'\\s\\/>]*)").exec(u[0])){r.select(l=u.index+m.index+1,l+c(m[1])-1);break}if("<"!==h[0]&&"</"!==h[0]&&(m=s("([^=\"'\\s]*\ufeff[^=\"'\\s]*)[=\\s\\/>]").exec(u[0]))){r.select(l=u.index+m.index,l+c(m[1])-1);break}r.select(l=u.index,l+c(u[0])-1);break}},r=1,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function k(e){var r=this.TextEditor,t=r.k();r&&!e.defaultPrevented&&(t.startsWith("Control-")||g(e,r))}function y(e){var r,t=this.TextEditor,n=t.k();if(t&&!e.defaultPrevented&&!t.keys[n]&&"Alt"!==n&&"Control"!==n){var i=n.split("-").pop(),o=t.$(),u=o.after,a=o.before;o.end;var l=o.start,d=o.value;if(""===i&&(i="-"),["-",">","/","?"," "].includes(i)){if("-"===i)return d||"<!-"!==a.slice(-3)?void 0:(v(e),t.wrap("- "," --"+(">"===u[0]?"":">")).record());if(">"===i||"/"===i){var p=s(h(b())+"$","").exec(a+">");if(!d&&p){if(v(e),"/"===i)return">"===u[0]?t.trim("",!1).insert(" /",-1).select(t.$().start+1).record():t.trim("",!1).insert(" />",-1).record();u.startsWith("></"+p[1]+">")?t.select(l+1).record():u.startsWith("</"+p[1]+">")?t.insert(">",-1).record():t.wrap(">","</"+p[1]+(">"===u[0]?"":">")).record()}return}return"?"===i?d||"<"!==a.slice(-1)?void 0:(v(e),t.wrap("?","?"+(">"===u[0]?"":">")).record()):" "===i&&!d&&("--\x3e"===u.slice(0,3)&&"\x3c!--"===a.slice(-4)||"?>"===u.slice(0,2)&&"<?"===a.slice(0,2)&&/<\?\S*$/.test(a))?(v(e),t.wrap(" "," ").record()):void 0}var x=t.$();if(u=x.after,a=x.before,x.end,l=x.start,d=x.value,"ArrowLeft"!==n){if("ArrowRight"!==n){var $=(null==(r=t.state.source)?void 0:r.tab)||t.state.tab||"\t",g=a.split("\n").pop().match(/^(\s+)/),k=g&&g[1]||"";if("Enter"!==n){if("Backspace"!==n){if("Delete"===n&&!d){if("--\x3e"===u.slice(0,3))return v(e),t.replace(/^-->/,"",1).record();if("?>"===u.slice(0,2))return v(e),t.replace(/^\?>/,"",1).record();var y=s("^"+w(),"");if(y.exec(u))return v(e),t.replace(y,"",1).record()}}else if(!d){if("\x3c!--"===a.slice(-4))return v(e),t.replace(/<!--$/,"",-1),"--\x3e"===u.slice(0,3)&&t.replace(/^-->/,"",1),t.record();if(/^\s+-->/.test(u)&&/<!--\s+$/.test(a))return v(e),t.trim(" "===a.slice(-1)?"":" "," "===u[0]?"":" ").record();if(/<\?\S*$/.test(a))return v(e),t.replace(/<\?\S*$/,"",-1),"?>"===u.slice(0,2)&&t.replace(/^\?>/,"",1),t.record();if(/^\s+\?>/.test(u)&&/<\?\S*\s+$/.test(a))return v(e),t.trim(" "===a.slice(-1)?"":" "," "===u[0]?"":" ").record();var E=s(w()+"$",""),L=E.exec(a);if(L){if(v(e)," />"===a.slice(-3))return t.replace(/ \/>$/,"/>",-1).record();if("/>"===a.slice(-2))return t.replace(/\/>$/,">",-1).record();t.replace(E,"",-1);var T=L[0].slice(1).split(/\s+|>/)[0];return L[0]&&"/"!==L[0][1]&&u.startsWith("</"+T+">")&&t.replace(s("^</"+T+">",""),"",1),t.record()}if(s(h(b())+"\\n(?:"+f($)+")?$","").test(a)&&s("^\\s*"+m(b()),"").test(u))return v(e),t.trim().record()}}else{var M=a.match(s(h(b())+"$",""));if(!d){if(M)return v(e),u.startsWith("</"+M[1]+">")?t.record().trim().wrap("\n"+k+$,"\n"+k).record():t.record().wrap("\n"+k+$,"\n"+k+"</"+M[1]+">").record();if(/^[ \t]*-->/.test(u)&&/<!--[ \t]*$/.test(a)||/^[ \t]*\?>/.test(u)&&/<\?\S*[ \t]*$/.test(a))return v(e),t.trim().wrap("\n"+k,"\n"+k).record()}}}else if(!d){var S=s("^"+w(),"").exec(u);if(S)return v(e),t.select(l,l+c(S[0]))}}else if(!d){var X=s(w()+"$","").exec(a);if(X)return v(e),t.select(l-c(X[0]),l)}}}function E(e){}function L(e){return k.call(this,e)}function T(e){if(!e)return"";e=o(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+l(d(t),!0)+'"'));return n}return{attach:function(e){var r,t=this;return t.insertXML=function(e,r,n,i){if(void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1),i){var c,o=t.$(),f=o.after,u=o.before,a=(null==(c=t.state.source)?void 0:c.tab)||t.state.tab||"\t";if(s("^"+m(b()),"").test(f)&&s(h(b())+"$","").test(u)){var l=u.split("\n").pop().match(/^(\s+)/),d=l&&l[1]||"";t.wrap("\n"+a+d,"\n"+d)}}return t.insert("<"+e+T(n)+(!1!==r?">"+r+"</"+e+">":" />"),-1,!0)},t.peelXML=function(e,r,n,i){return void 0===i&&(i=!1),i&&t.trim("",""),t.replace(s(h(e)+"$",""),"",-1).replace(s("^"+m(e)),"",1)},t.toggleXML=function(e,r,n,i){void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1);var c=t.$(),o=c.after,f=c.before,u=h(e),a=m(e),l=s(u+"$",""),d=s("^"+a,""),p=l.test(f),v=d.test(o);return t[(p&&v?"peel":"wrap")+"XML"](e,r,n,i)},t.wrapXML=function(e,r,n,i){void 0===r&&(r=""),void 0===n&&(n={}),void 0===i&&(i=!1);var c=t.$(),o=c.after,f=c.before;if(!c.value&&r&&t.insert(r),i){var u,a=(null==(u=t.state.source)?void 0:u.tab)||t.state.tab||"\t";if(s("^"+m(b()),"").test(o)&&s(h(b())+"$","").test(f)){var l=f.split("\n").pop().match(/^(\s+)/),d=l&&l[1]||"";t.wrap("\n"+a+d,"\n"+d)}}return t.wrap("<"+e+T(n)+">","</"+e+">")},"XML"===(null==(r=t.state.source)?void 0:r.type)&&(x("keydown",e,y),x("keyup",e,E),x("mousedown",e,k),x("touchstart",e,L)),t},detach:function(e){return p("keydown",e,y),p("keyup",e,E),p("mousedown",e,k),p("touchstart",e,L),$}}}));