/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e=function(e){return Array.isArray(e)},r=function(e,r){return e&&s(r)&&e instanceof r},t=function(e){return n(e)&&0==e%1},n=function(e){return"number"==typeof e},i=function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||r(e,Object))},s=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},a=function r(){for(var t=arguments.length,n=Array(t),c=0;c<t;c++)n[c]=arguments[c];for(var a,l=n.shift(),u=0,f=o(n);u<f;++u)for(var p in n[u])if(s(l[p]))if(e(l[p])&&e(n[u][p])){l[p]=[].concat(l[p]);for(var d=0,m=o(n[u][p]);d<m;++d)a=n[u][p][d],-1===l[p].indexOf(a)&&l[p].push(n[u][p][d])}else i(l[p])&&i(n[u][p])?l[p]=r({},l[p],n[u][p]):l[p]=n[u][p];else l[p]=n[u][p];return l},l=function r(t){if(e(t))return t.map((function(e){return r(t)}));if(i(t)){for(var n in t)t[n]=r(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},o=function(e){return e.length},u=function(e){return Object.keys(e)},f=function(e,t){return function(e){return r(e,RegExp)}(e)?e:RegExp(e,s(t)?t:"g")},p=function(e){return e&&e.preventDefault()},d=function(e){return"</("+e+")>"},m=function(){return"[\\w:.-]+"},$=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+d(m())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+m()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+$(m())+")"};function A(e){var r,n,i=this,c=i.k(!1).pop(),a=i.k();if(!e.defaultPrevented&&!i.keys[a]&&"Alt"!==a&&"Control"!==a){var l=i.$(),u=l.after,A=l.before;l.end;var x=l.start,D=l.value,C=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",g=i.state.elements||{},T=/^\s+/.exec(A.split("\n").pop()),w=T&&T[0]||"";if(t(C)&&(C=" ".repeat(C)),D){if("Backspace"===a)return"<![CDATA["===A.slice(-9)&&"]]>"===u.slice(0,3)&&D===g["#data"]?(p(e),i.insert("").record()):void 0;if("Delete"===a)return"<![CDATA["===A.slice(-9)&&"]]>"===u.slice(0,3)&&D===g["#data"]?(p(e),i.insert("").record()):void 0;if("Enter"===a){if("\x3c!-- "===A.slice(-5)&&" --\x3e"===u.slice(0,4)&&D===g["#comment"])return p(e),i.trim("\n"+w,"\n"+w).insert("").record();if("<![CDATA["===A.slice(-9)&&"]]>"===u.slice(0,3)&&D===g["#data"])return p(e),i.trim("\n"+w,"\n"+w).insert("").record();if((n=f($(m())+"$","").exec(A))&&u.startsWith("</"+n[1]+">")&&s(g[n[1]])&&D===g[n[1]][1])return p(e),i.trim("\n"+w+C,"\n"+w).insert("").record()}}else{if("-"===c)return"<!-"===A.slice(-3)?(p(e),i.insert(g["#comment"]||"").wrap("- "," --"+(">"===u[0]?"":">")).record()):void 0;if(">"===c||"/"===c){if(!(n=f($(m())+"$","").exec(A+">")))return;return p(e),"/"===c?">"===u[0]?i.trim("",!1).insert(" /",-1).select(i.$().start+1).record():i.trim("",!1).insert(" />",-1).record():s(g[n[1]])?!1===(D=g[n[1]][1])?">"===u[0]?i.trim("",!1).insert(" /",-1).select(i.$().start+1).record():i.trim("",!1).insert(" />",-1).record():(D&&i.insert(D),i.wrap(">","</"+n[1]+(">"===u[0]?"":">")).record()):u.startsWith("></"+n[1]+">")?i.select(x+1).record():u.startsWith("</"+n[1]+">")?i.insert(">",-1).record():i.wrap(">","</"+n[1]+(">"===u[0]?"":">")).record()}if("?"===c)return"<"===A.slice(-1)?(p(e),i.wrap("?","?"+(">"===u[0]?"":">")).record()):void 0;if("["===c)return"<![CDATA"===A.slice(-8)&&"]>"===u.slice(0,2)?i.insert(g["#data"]||""):void 0;if(" "===c)return"--\x3e"===u.slice(0,3)&&"\x3c!--"===A.slice(-4)||"?>"===u.slice(0,2)&&/<\?\S*$/.test(A)?(p(e),i.wrap(" "," ").record()):void 0;var h=i.$();if(u=h.after,A=h.before,h.end,x=h.start,!(D=h.value)){if("ArrowLeft"===a&&(n=f(v()+"$","").exec(A)))return p(e),i.select(x-o(n[0]),x);if("ArrowRight"===a&&(n=f("^"+v(),"").exec(u)))return p(e),i.select(x,x+o(n[0]));if(w=(T=/^\s+/.exec(A.split("\n").pop()))&&T[0]||"","Backspace"===a){if("\x3c!--"===A.slice(-4))return p(e),i.replace(/<!--$/,"",-1),"--\x3e"===u.slice(0,3)&&i.replace(/^-->/,"",1),i.record();if(/^(\n[ \t]*){2,}-->/.test(u)&&/<!--(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+w,"\n"+w).record();if(/^\s+-->/.test(u)&&/<!--\s+$/.test(A)){p(e);var b=u[0],S=A.slice(-1),y=" "===b&&" "===S?"":" ";return i.trim(y,y).record()}if("<![CDATA["===A.slice(-9))return p(e),i.replace(/<!\[CDATA\[$/,"",-1),"]]>"===u.slice(0,3)&&i.replace(/^\]\]>/,"",1),i.record();if(/<\?\S*$/.test(A))return p(e),i.replace(/<\?\S*$/,"",-1),"?>"===u.slice(0,2)&&i.replace(/^\?>/,"",1),i.record();if(/^(\n[ \t]*){2,}\?>/.test(u)&&/<\?\S*(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+w,"\n"+w).record();if(/^\s+\?>/.test(u)&&/<\?\S*\s+$/.test(A)){p(e);var E=u[0],k=A.slice(-1),W=" "===E&&" "===k?"":" ";return i.trim(W,W).record()}if("<![CDATA["===A.slice(-9))return p(e),i.replace(/<!\[CDATA\[$/,"",-1),"]]>"===u.slice(0,3)&&i.replace(/^\]\]>/,"",1),i.record();if(/^(\n[ \t]*){2,}\]\]>/.test(u)&&/<!\[CDATA\[(\n[ \t]*){2,}$/.test(A))return p(e),i.trim("\n"+w,"\n"+w).record();if(/^\s+\]\]>/.test(u)&&/<!\[CDATA\[\s+$/.test(A)){p(e);var j=u[0],O=A.slice(-1),R=" "===j&&" "===O?"":" ";return i.trim(R,R).record()}var B=f(v()+"$",""),L=B.exec(A);if(L){if(p(e)," />"===A.slice(-3))return i.replace(/ \/>$/,"/>",-1).record();if("/>"===A.slice(-2))return i.replace(/\/>$/,">",-1).record();i.replace(B,"",-1);var q=L[0].slice(1).split(/\s+|>/)[0];return L[0]&&"/"!==L[0][1]&&u.startsWith("</"+q+">")&&i.replace(f("^</"+q+">",""),"",1),i.record()}if(f("(^|\\n)([ \\t]*)"+$(m())+"\\n\\2$","").test(A)&&f("^\\s*"+d(m()),"").test(u))return p(e),i.trim().record()}if("Delete"===a){if("--\x3e"===u.slice(0,3))return p(e),i.replace(/^-->/,"",1).record();if("]]>"===u.slice(0,3))return p(e),i.replace(/^\]\]>/,"",1).record();if("?>"===u.slice(0,2))return p(e),i.replace(/^\?>/,"",1).record();var M=f("^"+v(),"");if(M.exec(u))return p(e),i.replace(M,"",1).record()}if("Enter"===a){if(/^[ \t]*-->/.test(u)&&/<!--[ \t]*$/.test(A)||/^[ \t]*\?>/.test(u)&&/<\?\S*[ \t]*$/.test(A)||/^[ \t]*\]\]>/.test(u)&&/<!\[CDATA\[[ \t]*$/.test(A))return p(e),i.trim("\n"+w,"\n"+w).record();if(/^(\n[ \t]*)-->/.test(u)&&/<!--(\n[ \t]*)$/.test(A)||/^(\n[ \t]*)\?>/.test(u)&&/<\?\S*(\n[ \t]*)$/.test(A)||/^(\n[ \t]*)\]\]>/.test(u)&&/<!\[CDATA\[(\n[ \t]*)$/.test(A))return p(e),i.trim("\n\n"+w,"\n\n"+w).record();if(n=f($(m())+"$","").exec(A))return p(e),u.startsWith("</"+n[1]+">")?i.record().trim("\n"+w+C,"\n"+w).record():i.record().wrap("\n"+w+C,"\n"+w+"</"+n[1]+">").record()}}}}}function x(e){if(!e)return"";e=u(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+c(l(t),!0)+'"'));return n}return{attach:function(){var r,t=this,n=/^\s*([\s\S]*?)\s*$/,i=/^<!--\s*([\s\S]*?)\s*-->$/,c=/^<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>$/;return t.state=r=a({elements:{"#comment":"Comment goes here…","#data":"Data goes here…"}},t.state),t.insertComment=function(e,n,i){return t.insert("\x3c!-- "+(e||r.elements["#comment"]||"")+" --\x3e",s(n)?n:-1,!s(i)||i)},t.insertData=function(e,n,i){return t.insert("<![CDATA["+(e||r.elements["#data"]||"")+"]]>",s(n)?n:-1,!s(i)||i)},t.insertElement=function(n,i,c){if(e(n)){var l;if(s(r.elements[n[0]]))n[1]=null!=(l=n[1])?l:r.elements[n[0]][1],n[2]=a({},r.elements[n[0]][2]||{},n[2]||{});n="<"+n[0]+x(n[2])+(!1===n[1]?" />":">"+(n[1]||"")+"</"+n[0]+">")}return t.insert(n,s(i)?i:-1,!s(c)||c)},t.peelComment=function(e){return e?t.replace(i,"$1"):t.replace(/<!--\s*$/,"",-1).replace(/^\s*-->/,"",1)},t.peelData=function(e){return e?t.replace(c,"$1"):t.replace(/<!\[CDATA\[\s*$/,"",-1).replace(/^\s*\]\]>/,"",1)},t.peelElement=function(n,i,c){if(e(n)){var l;if(s(r.elements[n[0]]))n[1]=null!=(l=n[1])?l:r.elements[n[0]][1],n[2]=a({},r.elements[n[0]][2]||{},n[2]||{});return(c=i)?t.replace(f("^"+$(n[0])+"([\\s\\S]*?)"+d(n[0])+"$",""),"$3"):t.replace(f($(n[0])+"$",""),"",-1).replace(f("^"+d(n[0])),"",1)}return t.peel(n,i,c)},t.toggleComment=function(e){var r=t.$(),n=r.after,s=r.before,c=r.value;return e?t[(i.test(c)?"peel":"wrap")+"Comment"](e):t[(/<!--\s*$/.test(s)&&/^\s*-->/.test(n)?"peel":"wrap")+"Comment"](e)},t.toggleData=function(e){var r=t.$(),n=r.after,i=r.before,s=r.value;return e?t[(c.test(s)?"peel":"wrap")+"Data"](e):t[(/<!\[CDATA\[\s*$/.test(i)&&/^\s*\]\]>/.test(n)?"peel":"wrap")+"Data"](e)},t.toggleElement=function(n,i,c){if(e(n)){var l;if(s(r.elements[n[0]]))n[1]=null!=(l=n[1])?l:r.elements[n[0]][1],n[2]=a({},r.elements[n[0]][2]||{},n[2]||{});c=i;var o=t.$(),u=o.after,p=o.before,m=o.value,v=$(n[0]),A=d(n[0]);return c?t[(f("^"+v+"[\\s\\S]*?"+A+"$","").test(m)?"peel":"wrap")+"Element"](n,i,c):t[(f(v+"$","").test(p)&&f("^"+A,"").test(u)?"peel":"wrap")+"Element"](n,i,c)}return t.toggle(n,i,c)},t.wrapComment=function(e){var i=t.$().value,s=r.elements["#comment"]||"";return!i&&s&&t.insert(s),e?t.replace(n,"\x3c!-- $1 --\x3e"):t.trim(!1,!1).replace(/$/,"\x3c!-- ",-1).replace(/^/," --\x3e",1)},t.wrapData=function(e){var i=t.$().value,s=r.elements["#data"]||"";return!i&&s&&t.insert(s),e?t.replace(n,"<![CDATA[$1]]>"):t.trim(!1,!1).replace(/$/,"<![CDATA[",-1).replace(/^/,"]]>",1)},t.wrapElement=function(i,c,l){if(e(i)){var o;if(s(r.elements[i[0]]))i[1]=null!=(o=i[1])?o:r.elements[i[0]][1],i[2]=a({},r.elements[i[0]][2]||{},i[2]||{});l=c;var u=t.$().value;return l?t.replace(n,"<"+i[0]+x(i[2])+">"+(u||i[1]||"").trim()+"</"+i[0]+">"):t.trim(!1,!1).replace(/$/,"<"+i[0]+x(i[2])+">",-1).replace(/^/,"</"+i[0]+">",1).insert(u||i[1]||"")}return t.wrap(i,c,l)},t.on("key.down",A)},detach:function(){return this.off("key.down",A)}}}));