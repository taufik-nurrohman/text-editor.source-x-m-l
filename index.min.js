/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=t())}(this,(function(){"use strict";var e=function(e){return Array.isArray(e)},t=function(e){return"function"==typeof e},r=function(e,t){return e&&c(t)&&e instanceof t},n=function(e){return s(e)&&0==e%1},s=function(e){return"number"==typeof e},i=function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||r(e,Object))},c=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},l=function(e){return e.length},a=function(e){return Object.keys(e)},o=function(e,t){return function(e){return r(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,c(t)?t:"g"))},u=function(e,t){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),t&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},f=function t(){for(var r=arguments.length,n=Array(r),s=0;s<r;s++)n[s]=arguments[s];for(var a,o=n.shift(),u=0,f=l(n);u<f;++u)for(var p in n[u])if(c(o[p]))if(e(o[p])&&e(n[u][p])){o[p]=[].concat(o[p]);for(var m=0,d=l(n[u][p]);m<d;++m)a=n[u][p][m],-1===o[p].indexOf(a)&&o[p].push(n[u][p][m])}else i(o[p])&&i(n[u][p])?o[p]=t({},o[p],n[u][p]):o[p]=n[u][p];else o[p]=n[u][p];return o},p=function t(r){if(e(r))return r.map((function(e){return t(r)}));if(i(r)){for(var n in r)r[n]=t(r[n]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},m=function(e){return e&&e.preventDefault()},d=function(e){return"</("+e+")>"},$=function(){return"[\\w:.-]+"},v=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},A=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>"},h=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+d($())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+A($())+"|"+v($())+")"},x="ArrowLeft",D="ArrowRight",C="Backspace",g="Delete",T="Enter";function w(e){var t,r=this,s=r.k(!1).pop(),i=r.k();if(!e.defaultPrevented&&!r.keys[i]&&"Alt"!==i&&"Control"!==i){var a=r.$(),u=a.after,f=a.before;a.end;var p=a.start,A=a.value,w=r.state.tab||"\t",E=r.state.elements||{},S=/^\s+/.exec(f.split("\n").pop()),b=S&&S[0]||"";if(n(w)&&(w=" ".repeat(w)),A){if(C===i)return"<![CDATA["===f.slice(-9)&&"]]>"===u.slice(0,3)&&A===E["![CDATA["]?(m(e),r.insert("").record()):void 0;if(g===i)return"<![CDATA["===f.slice(-9)&&"]]>"===u.slice(0,3)&&A===E["![CDATA["]?(m(e),r.insert("").record()):void 0;if(T===i){if("\x3c!-- "===f.slice(-5)&&" --\x3e"===u.slice(0,4)&&A===E["!--"])return m(e),r.trim("\n"+b,"\n"+b).insert("").record();if("<![CDATA["===f.slice(-9)&&"]]>"===u.slice(0,3)&&A===E["![CDATA["])return m(e),r.trim("\n"+b,"\n"+b).insert("").record();if((t=o(v($())+"$","").exec(f))&&u.startsWith("</"+t[1]+">")&&c(E[t[1]])&&A===E[t[1]][1])return m(e),r.trim("\n"+b+w,"\n"+b).insert("").record()}}else{if("-"===s)return"<!-"===f.slice(-3)?(m(e),r.insert(E["!--"]||"").wrap("- "," --"+(">"===u[0]?"":">")).record()):void 0;if(">"===s||"/"===s){if(!(t=o(v($())+"$","").exec(f+">")))return;return m(e),"/"===s?">"===u[0]?r.trim("",!1).insert(" /",-1).select(r.$().start+1).record():r.trim("",!1).insert(" />",-1).record():c(E[t[1]])?!1===(A=E[t[1]][1])?">"===u[0]?r.trim("",!1).insert(" /",-1).select(r.$().start+1).record():r.trim("",!1).insert(" />",-1).record():(A&&r.insert(A),r.wrap(">","</"+t[1]+(">"===u[0]?"":">")).record()):r.wrap(">","</"+t[1]+(">"===u[0]?"":">")).record()}if("?"===s)return"<"===f.slice(-1)?(m(e),r.wrap("?","?"+(">"===u[0]?"":">")).record()):void 0;if("["===s)return"<![CDATA"===f.slice(-8)&&"]>"===u.slice(0,2)?r.insert(E["![CDATA["]||""):void 0;if(" "===s)return"--\x3e"===u.slice(0,3)&&"\x3c!--"===f.slice(-4)||"?>"===u.slice(0,2)&&/<\?\S*$/.test(f)?(m(e),"?>"===u.slice(0,2)&&r.insert(E["?"]||""),r.wrap(" "," ").record()):void 0;var y=r.$();if(u=y.after,f=y.before,y.end,p=y.start,!(A=y.value)){if(x===i&&(t=o(h()+"$","").exec(f)))return m(e),r.select(p-l(t[0]),p);if(D===i&&(t=o("^"+h(),"").exec(u)))return m(e),r.select(p,p+l(t[0]));if(b=(S=/^\s+/.exec(f.split("\n").pop()))&&S[0]||"",C===i){if("\x3c!--"===f.slice(-4))return m(e),r.replace(/<!--$/,"",-1),"--\x3e"===u.slice(0,3)&&r.replace(/^-->/,"",1),r.record();if(/^(\n[ \t]*){2,}-->/.test(u)&&/<!--(\n[ \t]*){2,}$/.test(f))return m(e),r.trim("\n"+b,"\n"+b).record();if(/^\s+-->/.test(u)&&/<!--\s+$/.test(f)){m(e);var I=u[0],k=f.slice(-1),j=" "===I&&" "===k?"":" ";return r.trim(j,j).record()}if("<![CDATA["===f.slice(-9))return m(e),r.replace(/<!\[CDATA\[$/,"",-1),"]]>"===u.slice(0,3)&&r.replace(/^\]\]>/,"",1),r.record();if(/<\?\S*$/.test(f))return m(e),r.replace(/<\?\S*$/,"",-1),"?>"===u.slice(0,2)&&r.replace(/^\?>/,"",1),r.record();if(/^(\n[ \t]*){2,}\?>/.test(u)&&/<\?\S*(\n[ \t]*){2,}$/.test(f))return m(e),r.trim("\n"+b,"\n"+b).record();if(/^\s+\?>/.test(u)&&/<\?\S*\s+$/.test(f)){m(e);var L=u[0],O=f.slice(-1),R=" "===L&&" "===O?"":" ";return r.trim(R,R).record()}if("<![CDATA["===f.slice(-9))return m(e),r.replace(/<!\[CDATA\[$/,"",-1),"]]>"===u.slice(0,3)&&r.replace(/^\]\]>/,"",1),r.record();if(/^(\n[ \t]*){2,}\]\]>/.test(u)&&/<!\[CDATA\[(\n[ \t]*){2,}$/.test(f))return m(e),r.trim("\n"+b,"\n"+b).record();if(/^\s+\]\]>/.test(u)&&/<!\[CDATA\[\s+$/.test(f)){m(e);var W=u[0],M=f.slice(-1),X=" "===W&&" "===M?"":" ";return r.trim(X,X).record()}var q=o(h()+"$",""),B=q.exec(f);if(B){if(m(e)," />"===f.slice(-3))return r.replace(/ \/>$/,"/>",-1).record();if("/>"===f.slice(-2))return r.replace(/\/>$/,">",-1).record();r.replace(q,"",-1);var P=B[0].slice(1).split(/\s+|>/)[0];return B[0]&&"/"!==B[0][1]&&u.startsWith("</"+P+">")&&r.replace(o("^</"+P+">",""),"",1),r.record()}if(o("(^|\\n)([ \\t]*)"+v($())+"\\n\\2$","").test(f)&&o("^\\s*"+d($()),"").test(u))return m(e),r.trim().record()}if(g===i){if("--\x3e"===u.slice(0,3))return m(e),r.replace(/^-->/,"",1).record();if("]]>"===u.slice(0,3))return m(e),r.replace(/^\]\]>/,"",1).record();if("?>"===u.slice(0,2))return m(e),r.replace(/^\?>/,"",1).record();var _=o("^"+h(),"");if(_.exec(u))return m(e),r.replace(_,"",1).record()}if(T===i){if(/^[ \t]*-->/.test(u)&&/<!--[ \t]*$/.test(f)||/^[ \t]*\?>/.test(u)&&/<\?\S*[ \t]*$/.test(f)||/^[ \t]*\]\]>/.test(u)&&/<!\[CDATA\[[ \t]*$/.test(f))return m(e),r.trim("\n"+b,"\n"+b).record();if(/^(\n[ \t]*)-->/.test(u)&&/<!--(\n[ \t]*)$/.test(f)||/^(\n[ \t]*)\?>/.test(u)&&/<\?\S*(\n[ \t]*)$/.test(f)||/^(\n[ \t]*)\]\]>/.test(u)&&/<!\[CDATA\[(\n[ \t]*)$/.test(f))return m(e),r.trim("\n\n"+b,"\n\n"+b).record();if(t=o(v($())+"$","").exec(f))return m(e),u.startsWith("</"+t[1]+">")?r.record().trim("\n"+b+w,"\n"+b).record():r.record().wrap("\n"+b+w,"\n"+b+"</"+t[1]+">").record()}}}}}function E(e){w.call(this,e)}function S(e){if(!e)return"";e=a(e).sort().reduce((function(t,r){return t[r]=e[r],t}),{});var t,r,n="";for(t in e)!1!==(r=e[t])&&null!==r&&(n+=" "+t,!0!==r&&(n+='="'+u(p(r),!0)+'"'));return n}var b={attach:function(){var r=this,n=r.constructor._,s=/^\s*([\s\S]*?)\s*$/,i=/^<!--\s*([\s\S]*?)\s*-->$/,a=/^<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>$/,u=/^<\?\S*\s*([\s\S]*?)\s*\?>$/;return r.state=f({elements:{"!--":"Comment goes here…","![CDATA[":"Data goes here…","?":"Instruction goes here…"}},r.state),!t(n.insertComment)&&(n.insertComment=function(e,t,r){return"\n"!==(e=e||this.state.elements["!--"]||"")[0]&&"\n"!==e.slice(-1)&&(e=" "+e+" "),this.insert("\x3c!--"+e+"--\x3e",c(t)?t:-1,!c(r)||r)}),!t(n.insertData)&&(n.insertData=function(e,t,r){return this.insert("<![CDATA["+(e||this.state.elements["![CDATA["]||"")+"]]>",c(t)?t:-1,!c(r)||r)}),!t(n.insertElement)&&(n.insertElement=function(t,r,n){var s=this.state.elements;if(e(t)){var i;if(c(s[t[0]]))t[1]=null!=(i=t[1])?i:s[t[0]][1],t[2]=f({},s[t[0]][2]||{},t[2]||{});t="<"+t[0]+S(t[2])+(!1===t[1]?" />":">"+(t[1]||"")+"</"+t[0]+">")}return this.insert(t,c(r)?r:-1,!c(n)||n)}),!t(n.insertInstruction)&&(n.insertInstruction=function(e,t,r,n){void 0===n&&(n="xml");return"\n"!==(e=e||this.state.elements["?"]||"")[0]&&"\n"!==e.slice(-1)&&(e=" "+e+" "),this.insert("<?"+(n||"")+e+"?>",c(t)?t:-1,!c(r)||r)}),!t(n.peelComment)&&(n.peelComment=function(e){return e?this.replace(i,"$1"):this.replace(/<!--\s*$/,"",-1).replace(/^\s*-->/,"",1)}),!t(n.peelData)&&(n.peelData=function(e){return e?this.replace(a,"$1"):this.replace(/<!\[CDATA\[\s*$/,"",-1).replace(/^\s*\]\]>/,"",1)}),!t(n.peelElement)&&(n.peelElement=function(t,r,n){var s=this,i=s.state.elements;if(e(t)){var l;if(c(i[t[0]]))t[1]=null!=(l=t[1])?l:i[t[0]][1],t[2]=f({},i[t[0]][2]||{},t[2]||{});return(n=r)?s.replace(o("^"+v(t[0])+"([\\s\\S]*?)"+d(t[0])+"$",""),"$3"):s.replace(o(v(t[0])+"$",""),"",-1).replace(o("^"+d(t[0])),"",1)}return s.peel(t,r,n)}),!t(n.peelInstruction)&&(n.peelInstruction=function(e){return e?this.replace(u,"$1"):this.replace(/<\?\S*\s*$/,"",-1).replace(/^\s*\?>/,"",1)}),!t(n.selectComment)&&(n.selectComment=function(e){for(var t=this,r=t.$(),n=r.after,s=r.before,i=r.end,c=r.start,a=r.value;s&&"\x3c!--"!==a.slice(0,4);)a=s.slice(-1)+a,s=s.slice(0,-1),c-=1;for(;n&&"--\x3e"!==a.slice(-3);)a+=n.slice(0,1),n=n.slice(1),i+=1;if(!e){var o=a.slice(4,-3),u=/\s+$/.exec(o),f=/^\s+/.exec(o);u&&(i-=3+l(u[0])),f&&(c+=4+l(f[0]))}return"\x3c!--"===a.slice(0,4)&&"--\x3e"===a.slice(-3)?t.select(c,i):t.select()}),!t(n.selectData)&&(n.selectData=function(e){for(var t=this,r=t.$(),n=r.after,s=r.before,i=r.end,c=r.start,a=r.value;s&&"<![CDATA["!==a.slice(0,9);)a=s.slice(-1)+a,s=s.slice(0,-1),c-=1;for(;n&&"]]>"!==a.slice(-3);)a+=n.slice(0,1),n=n.slice(1),i+=1;if(!e){var o=a.slice(9,-3),u=/\s+$/.exec(o),f=/^\s+/.exec(o);u&&(i-=3+l(u[0])),f&&(c+=9+l(f[0]))}return"<![CDATA["===a.slice(0,9)&&"]]>"===a.slice(-3)?t.select(c,i):t.select()}),!t(n.selectElement)&&(n.selectElement=function(){for(var e=this,t=e.$(),r=t.after,n=t.before,s=t.end,i=t.start,c=t.value;n&&"<"!==c.slice(0,1);)c=n.slice(-1)+c,n=n.slice(0,-1),i-=1;for(;r&&">"!==c.slice(-1);)c+=r.slice(0,1),r=r.slice(1),s+=1;return o("^("+d($())+"|"+v($())+"|"+A($())+")$").test(c)?e.select(i,s):e.select()}),!t(n.selectInstruction)&&(n.selectInstruction=function(e,t){void 0===t&&(t="xml");for(var r=this,n=r.$(),s=n.after,i=n.before,a=n.end,o=n.start,u=n.value;i&&"<?"!==u.slice(0,2);)u=i.slice(-1)+u,i=i.slice(0,-1),o-=1;for(;s&&"?>"!==u.slice(-2);)u+=s.slice(0,1),s=s.slice(1),a+=1;if(c(t)||(t=u.slice(2).split(/\s+/).shift()),!e){var f=u.slice(2+(t?l(t):0),-2),p=/\s+$/.exec(f),m=/^\s+/.exec(f);p&&(a-=2+l(p[0])),m&&(o+=2+(t?l(t):0)+l(m[0]))}return"<?"===u.slice(0,2)&&"?>"===u.slice(-2)?r.select(o,a):r.select()}),!t(n.toggleComment)&&(n.toggleComment=function(e){var t=this,r=t.$(),n=r.after,s=r.before,c=r.value;return e?t[(i.test(c)?"peel":"wrap")+"Comment"](e):t[(/<!--\s*$/.test(s)&&/^\s*-->/.test(n)?"peel":"wrap")+"Comment"](e)}),!t(n.toggleData)&&(n.toggleData=function(e){var t=this,r=t.$(),n=r.after,s=r.before,i=r.value;return e?t[(a.test(i)?"peel":"wrap")+"Data"](e):t[(/<!\[CDATA\[\s*$/.test(s)&&/^\s*\]\]>/.test(n)?"peel":"wrap")+"Data"](e)}),!t(n.toggleElement)&&(n.toggleElement=function(t,r,n){var s=this,i=s.state.elements;if(e(t)){var l;if(c(i[t[0]]))t[1]=null!=(l=t[1])?l:i[t[0]][1],t[2]=f({},i[t[0]][2]||{},t[2]||{});n=r;var a=s.$(),u=a.after,p=a.before,m=a.value,$=v(t[0]),A=d(t[0]);return n?s[(o("^"+$+"[\\s\\S]*?"+A+"$","").test(m)?"peel":"wrap")+"Element"](t,r,n):s[(o($+"$","").test(p)&&o("^"+A,"").test(u)?"peel":"wrap")+"Element"](t,r,n)}return s.toggle(t,r,n)}),!t(n.toggleInstruction)&&(n.toggleInstruction=function(e,t){void 0===t&&(t="xml");var r=this,n=r.$(),s=n.after,i=n.before,c=n.value;return e?r[(u.test(c)?"peel":"wrap")+"Instruction"](e,t):r[(/<\?\S*\s*$/.test(i)&&/^\s*\?>/.test(s)?"peel":"wrap")+"Instruction"](e,t)}),!t(n.wrapComment)&&(n.wrapComment=function(e){var t=this,r=t.$().value,n=t.state.elements["!--"]||"";return!r&&n&&t.insert(n),e?t.replace(s,"\x3c!-- $1 --\x3e"):t.trim(!1,!1).replace(/$/,"\x3c!-- ",-1).replace(/^/," --\x3e",1)}),!t(n.wrapData)&&(n.wrapData=function(e){var t=this,r=t.$().value,n=t.state.elements["![CDATA["]||"";return!r&&n&&t.insert(n),e?t.replace(s,"<![CDATA[$1]]>"):t.trim(!1,!1).replace(/$/,"<![CDATA[",-1).replace(/^/,"]]>",1)}),!t(n.wrapElement)&&(n.wrapElement=function(t,r,n){var i=this,l=i.state.elements;if(e(t)){var a;if(c(l[t[0]]))t[1]=null!=(a=t[1])?a:l[t[0]][1],t[2]=f({},l[t[0]][2]||{},t[2]||{});n=r;var o=i.$().value;return n?i.replace(s,"<"+t[0]+S(t[2])+">"+(o||t[1]||"").trim()+"</"+t[0]+">"):i.trim(!1,!1).replace(/$/,"<"+t[0]+S(t[2])+">",-1).replace(/^/,"</"+t[0]+">",1).insert(o||t[1]||"")}return i.wrap(t,r,n)}),!t(n.wrapInstruction)&&(n.wrapInstruction=function(e,t){void 0===t&&(t="xml");var r=this,n=r.$().value,i=r.state.elements["?"]||"";return!n&&i&&r.insert(i),e?r.replace(s,"<?"+t+" $1 ?>"):r.trim(!1,!1).replace(/$/,"<?"+t+" ",-1).replace(/^/," ?>",1)}),r.on("key.down",w).on("put.down",E).record()},detach:function(){return this.off("key.down",w).off("put.down",E)},name:"TextEditor.SourceXML"};return b}));