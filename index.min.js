/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e,r,t,n=function(e){return Array.isArray(e)},i=function(e,r){return e&&a(r)&&e instanceof r},c=function(e){return s(e)&&0==e%1},s=function(e){return"number"==typeof e},a=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},u=function(e){return e.length},f=function(e){return Object.keys(e)},o=function(e,r){return function(e){return i(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,a(r)?r:"g"))},l=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},p=function e(r){if(n(r))return r.map((function(t){return e(r)}));if(function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||i(e,Object))}(r)){for(var t in r)r[t]=e(r[t]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},d=function(e){return e&&e.preventDefault()},$=function(){return"[\\w:.-]+"},v=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},x=function(e){return"</("+e+")>"},m=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+x($())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+$()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+v($())+")"},w=(e=function(e,r){var t=r.$(),n=t.after,i=t.before,c=t.end,s=t.value;if(!s)for(var a,f,l,p="\ufeff",v=m().split("("+$()+")").join("((?:"+$()+"|\ufeff)+)"),x=o(v),w=i+s+p+n;a=x.exec(w);)if(l=p,-1!==a[0].indexOf(l)){d(e);var g=a[0].split(p);if(">"===g[1]||"/>"===(g[1]||"").trim()){r.select(f=a.index,f+u(a[0])-1);break}if("<"!==g[0]&&"</"!==g[0]&&!/\s/.test(g[0])){r.select(f=a.index+("/"===g[0][1]?2:1),c+u(g[1].split(/[\s\/>]/).shift()));break}var b=void 0;if(b=o("=(\"[^\"]*\ufeff[^\"]*\"|'[^']*\ufeff[^']*')").exec(a[0])){r.select(f=a.index+b.index+2,f+u(b[1])-3);break}if(b=o("=([^\"'\\s\\/>]*\ufeff[^\"'\\s\\/>]*)").exec(a[0])){r.select(f=a.index+b.index+1,f+u(b[1])-1);break}if("<"!==g[0]&&"</"!==g[0]&&(b=o("([^=\"'\\s]*\ufeff[^=\"'\\s]*)[=\\s\\/>]").exec(a[0]))){r.select(f=a.index+b.index,f+u(b[1])-1);break}r.select(f=a.index,f+u(a[0])-1);break}},r=1,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function g(e){var r,t=this,n=t.k(!1).pop(),i=t.k();if(t&&!e.defaultPrevented&&!t.keys[i]&&"Alt"!==i&&"Control"!==i){var s=t.$(),a=s.after,f=s.before;s.end;var l=s.start,p=s.value;if(["-",">","/","?"," "].includes(n)){if("-"===n)return p||"<!-"!==f.slice(-3)?void 0:(d(e),t.wrap("- "," --"+(">"===a[0]?"":">")).record());if(">"===n||"/"===n){var w=o(v($())+"$","").exec(f+">");if(!p&&w){if(d(e),"/"===n)return">"===a[0]?t.trim("",!1).insert(" /",-1).select(t.$().start+1).record():t.trim("",!1).insert(" />",-1).record();a.startsWith("></"+w[1]+">")?t.select(l+1).record():a.startsWith("</"+w[1]+">")?t.insert(">",-1).record():t.wrap(">","</"+w[1]+(">"===a[0]?"":">")).record()}return}return"?"===n?p||"<"!==f.slice(-1)?void 0:(d(e),t.wrap("?","?"+(">"===a[0]?"":">")).record()):" "===n&&!p&&("--\x3e"===a.slice(0,3)&&"\x3c!--"===f.slice(-4)||"?>"===a.slice(0,2)&&"<?"===f.slice(0,2)&&/<\?\S*$/.test(f))?(d(e),t.wrap(" "," ").record()):void 0}var g=t.$();if(a=g.after,f=g.before,g.end,l=g.start,p=g.value,"ArrowLeft"!==i){if("ArrowRight"!==i){var b=(null==(r=t.state.source)?void 0:r.tab)||t.state.tab||"\t",h=f.split("\n").pop().match(/^(\s+)/),A=h&&h[1]||"";if(c(b)&&(b=" ".repeat(b)),"Enter"!==i){if("Backspace"!==i){if("Delete"===i&&!p){if("--\x3e"===a.slice(0,3))return d(e),t.replace(/^-->/,"",1).record();if("?>"===a.slice(0,2))return d(e),t.replace(/^\?>/,"",1).record();var S=o("^"+m(),"");if(S.exec(a))return d(e),t.replace(S,"",1).record()}}else if(!p){if("\x3c!--"===f.slice(-4))return d(e),t.replace(/<!--$/,"",-1),"--\x3e"===a.slice(0,3)&&t.replace(/^-->/,"",1),t.record();if(/^\s+-->/.test(a)&&/<!--\s+$/.test(f))return d(e),t.trim(" "===f.slice(-1)?"":" "," "===a[0]?"":" ").record();if(/<\?\S*$/.test(f))return d(e),t.replace(/<\?\S*$/,"",-1),"?>"===a.slice(0,2)&&t.replace(/^\?>/,"",1),t.record();if(/^\s+\?>/.test(a)&&/<\?\S*\s+$/.test(f))return d(e),t.trim(" "===f.slice(-1)?"":" "," "===a[0]?"":" ").record();var k=o(m()+"$",""),C=k.exec(f);if(C){if(d(e)," />"===f.slice(-3))return t.replace(/ \/>$/,"/>",-1).record();if("/>"===f.slice(-2))return t.replace(/\/>$/,">",-1).record();t.replace(k,"",-1);var D=C[0].slice(1).split(/\s+|>/)[0];return C[0]&&"/"!==C[0][1]&&a.startsWith("</"+D+">")&&t.replace(o("^</"+D+">",""),"",1),t.record()}if(o("(^|\\n)([ \\t]*)"+v($())+"\\n\\2?$","").test(f)&&o("^\\s*"+x($()),"").test(a))return d(e),t.trim().record()}}else{var y=f.match(o(v($())+"$",""));if(!p){if(y)return d(e),a.startsWith("</"+y[1]+">")?t.record().trim().wrap("\n"+A+b,"\n"+A).record():t.record().wrap("\n"+A+b,"\n"+A+"</"+y[1]+">").record();if(/^[ \t]*-->/.test(a)&&/<!--[ \t]*$/.test(f)||/^[ \t]*\?>/.test(a)&&/<\?\S*[ \t]*$/.test(f))return d(e),t.trim().wrap("\n"+A,"\n"+A).record();if(/^\n-->/.test(a)&&/<!--\n$/.test(f)||/^\n\?>/.test(a)&&/<\?\S*\n$/.test(f))return d(e),t.trim().wrap("\n\n"+A,"\n\n"+A).record()}}}else if(!p){var T=o("^"+m(),"").exec(a);if(T)return d(e),t.select(l,l+u(T[0]))}}else if(!p){var E=o(m()+"$","").exec(f);if(E)return d(e),t.select(l-u(E[0]),l)}}}function b(e){var r=this;r.k(!1).pop();var t=r.k();r&&!e.defaultPrevented&&(t.startsWith("Control-")||w(e,r))}function h(e){if(!e)return"";e=f(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+l(p(t),!0)+'"'));return n}return{attach:function(){var e,r=this;return r.insertComment=function(e,t,n){return r.insert("\x3c!--"+e+"--\x3e",a(t)?t:-1,!a(n)||n)},r.insertData=function(e,t,n){return r.insert("<![CDATA["+e+"]]>",a(t)?t:-1,!a(n)||n)},r.insertElement=function(e,t,i){return n(e)&&(e="<"+e[0]+h(e[2])+(!1===e[1]?" />":">"+(e[1]||"")+"</"+e[0]+">")),r.insert(e,a(t)?t:-1,!a(i)||i)},r.peelComment=function(e){return e?r.replace(/^<!--([\s\S]*?)-->$/,"$1"):r.replace(/<!--(\s*)$/,"$1",-1).replace(/^(\s*)-->/,"$1",1)},r.peelData=function(e){return e?r.replace(/^<!\[CDATA\[([\s\S]*?)\]\]>$/,"$1"):r.replace(/<!\[CDATA\[(\s*)$/,"$1",-1).replace(/^(\s*)\]\]>/,"$1",1)},r.peelElement=function(e,t,i){return n(e)?(i=t)?r.replace(o("^"+v(e[0])+"([\\s\\S]*?)"+x(e[0])+"$",""),"$3"):r.replace(o(v(e[0])+"$",""),"",-1).replace(o("^"+x(e[0])),"",1):r.peel(e,t,i)},r.toggleComment=function(e){var t=r.$(),n=t.after,i=t.before,c=t.value;return e?r[(/^<!--[\s\S]*?-->$/.test(c)?"peel":"wrap")+"Comment"](e):r[(/<!--\s*$/.test(i)&&/^\s*-->/.test(n)?"peel":"wrap")+"Comment"](e)},r.toggleData=function(e){var t=r.$(),n=t.after,i=t.before,c=t.value;return e?r[(/^<!\[CDATA\[[\s\S]*?\]\]>$/.test(c)?"peel":"wrap")+"Data"](e):r[(/<!\[CDATA\[\s*$/.test(i)&&/^\s*\]\]>/.test(n)?"peel":"wrap")+"Data"](e)},r.toggleElement=function(e,t,i){if(n(e)){i=t;var c=r.$(),s=c.after,a=c.before,u=c.value,f=v(e[0]),l=x(e[0]);return i?r[(o("^"+f+"[\\s\\S]*?"+l+"$","").test(u)?"peel":"wrap")+"Element"](e,t,i):r[(o(f+"$","").test(a)&&o("^"+l,"").test(s)?"peel":"wrap")+"Element"](e,t,i)}return r.toggle(e,t,i)},r.wrapComment=function(e){return e?r.replace(/^([\s\S]*?)$/,"\x3c!--$1--\x3e"):r.replace(/^/,"\x3c!--",-1).replace(/$/,"--\x3e",1)},r.wrapData=function(e){return e?r.replace(/^([\s\S]*?)$/,"<![CDATA[$1]]>"):r.replace(/^/,"<![CDATA[",-1).replace(/$/,"]]>",1)},r.wrapElement=function(e,t,i){if(n(e)){i=t;var c=r.$().value;return i?r.replace(/^[\s\S]*?$/,"<"+e[0]+h(e[2])+">"+(c||e[1]||"")+"</"+e[0]+">"):r.replace(/^/,"<"+e[0]+h(e[2])+">",-1).replace(/$/,"</"+e[0]+">",1).insert(c||e[1]||"")}return r.wrap(e,t,i)},"XML"===(null==(e=r.state.source)?void 0:e.type)&&(r.on("key.down",g),r.on("mouse.down",b)),r},detach:function(){var e=this;return e.off("key.down",g),e.off("mouse.down",b),e}}}));