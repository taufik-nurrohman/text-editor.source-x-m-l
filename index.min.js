/*!
 *
 * The MIT License (MIT)

 * Copyright © 2021 Taufik Nurrohman <https://github.com/taufik-nurrohman>

 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceXML={}))}(this,(function(e){"use strict";var r=function(e,r){return e&&t(r)&&e instanceof r},t=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},n=function(e){return e.length},i=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")},c=function e(t){if(function(e){return Array.isArray(e)}(t))return t.map((function(r){return e(t)}));if(function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||r(e,Object))}(t)){for(var n in t)t[n]=e(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},f=function(e,n){return function(e){return r(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,t(n)?n:"g"))},l="!$^*()+=[]{}|:<>,.?/-";let o="[\\w:.-]+",u=e=>"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",s=e=>"</("+e+")>",a="(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+s(o)+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+u(o)+"|"+("<("+o+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>)");const p={};p.toggle=function(e,r="",n={},l=!1){let o=this,{after:a,before:p,value:d}=o.$(),$=u(e),x=s(e),w=f($+"$",""),g=f("^"+x,""),m=w.test(p),b=g.test(a);return b&&m?o.replace(g,"",1).replace(w,"",-1):(w=f("^"+$,""),g=f(x+"$",""),m=w.test(d),b=g.test(d),b&&m&&o.insert(d=d.replace(g,"").replace(w,"")),!d&&r&&o.insert(r),!1!==(l=function(e){return!1!==e&&(e=function(e){return"string"==typeof e}(e)?[e,e]:["",""],t(e[1])||(e[1]=e[0])),e}(l))&&o.trim(l[0],l[1]),o.wrap("<"+e+function(e){if(!e)return"";let r,t="";for(r in e)t+=" "+r+'="'+i(c(e[r]))+'"';return t}(n)+">","</"+e+">"))};let d={source:{type:"XML"},sourceXML:{}};e.canKeyDown=function(e,{a:r,c:t,s:i},c){let p=c.state,d=p.sourceXML.tab||p.tab||"\t";if(r||t)return!0;if(["-",">","/","?"," "].includes(e)){let{after:r,before:t,value:i,start:l}=c.$();if("-"===e&&!i&&"<!-"===t.slice(-3))return c.wrap("- "," --"+(">"===r[0]?"":">")).record(),!1;if(">"===e||"/"===e){let s=f(u(o)+"$","").exec(t+">");if(!i&&s)return"/"===e?">"===r[0]?(c.trim("",!1).insert(" /",-1).select(c.$().start+1).record(),!1):(c.trim("",!1).insert(" />",-1).record(),!1):("></"+s[1]+">"===r.slice(0,n(s[1])+4)?c.select(l+1).record():"</"+s[1]+">"===r.slice(0,n(s[1])+3)?c.insert(">",-1).record():c.wrap(">","</"+s[1]+(">"===r[0]?"":">")).record(),!1)}if("?"===e&&!i&&"<"===t.slice(-1))return c.wrap("?","?"+(">"===r[0]?"":">")).record(),!1;if(" "===e&&!i){if("\x3c!--"===t.slice(-4)&&"--\x3e"===r.slice(0,3))return c.wrap(" "," ").record(),!1;if(/<\?\S*$/.test(t)&&"?>"===r.slice(0,2))return c.wrap(" "," ").record(),!1}}if("ArrowLeft"===e&&!i){let{before:e,start:r,value:t}=c.$();if(!t){let t=f(a+"$","").exec(e);if(t)return c.select(r-n(t[0]),r),!1}}if("ArrowRight"===e&&!i){let{after:e,start:r,value:t}=c.$();if(!t){let t=f("^"+a,"").exec(e);if(t)return c.select(r,r+n(t[0])),!1}}if("Enter"===e&&!i){let{after:e,before:r,value:t}=c.$(),n=r.split("\n").pop().match(/^(\s+)/),i=n&&n[1]||"",l=r.match(f(u(o)+"$",""));if(!t){if(/^[ \t]*-->/.test(e)&&/<!--[ \t]*$/.test(r))return c.trim().wrap("\n\n"+i,"\n\n"+i).record(),!1;if(/^[ \t]*\?>/.test(e)&&/<\?\S*[ \t]*$/.test(r))return c.trim().wrap("\n\n"+i,"\n\n"+i).record(),!1;if(l)return f("^</"+l[1]+">","").test(e)?c.record().trim().wrap("\n"+i+d,"\n"+i).record():c.record().wrap("\n"+i+d,"\n"+i+"</"+l[1]+">").record(),!1}}if("Backspace"===e&&!i){let{after:e,before:r,value:t}=c.$();if(!t){if("\x3c!--"===r.slice(-4))return c.replace(/<!--$/,"",-1),"--\x3e"===e.slice(0,3)&&c.replace(/^-->/,"",1),c.record(),!1;if(/^\s+-->/.test(e)&&/<!--\s+$/.test(r))return c.trim(" "===r.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;if(/<\?\S*$/.test(r))return c.replace(/<\?\S*$/,"",-1),"?>"===e.slice(0,2)&&c.replace(/^\?>/,"",1),c.record(),!1;if(/^\s+\?>/.test(e)&&/<\?\S*\s+$/.test(r))return c.trim(" "===r.slice(-1)?"":" "," "===e[0]?"":" ").record(),!1;let t=f(a+"$",""),i=t.exec(r);if(i){if(" />"===r.slice(-3))return c.replace(/ \/>$/,"/>",-1).record(),!1;if("/>"===r.slice(-2))return c.replace(/\/>$/,">",-1).record(),!1;c.replace(t,"",-1);let l=i[0].slice(1).split(/\s+|>/)[0];return i[0]&&"/"!==i[0][1]&&"</"+l+">"===e.slice(0,n(l)+3)&&c.replace(f("^</"+l+">",""),"",1),c.record(),!1}if(f(u(o)+"\\n(?:"+($=d,void 0===x&&(x=""),$.replace(f("["+x+l.replace(/./g,"\\$&")+"]"),"\\$&")+")?$"),"").test(r)&&f("^\\s*"+s(o),"").test(e))return c.trim().record(),!1}}var $,x;if("Delete"===e&&!i){let{after:e,value:r}=c.$();if(!r){if("--\x3e"===e.slice(0,3))return c.replace(/^-->/,"",1).record(),!1;if("?>"===e.slice(0,2))return c.replace(/^\?>/,"",1).record(),!1;let r=f("^"+a,"");if(r.exec(e))return c.replace(r,"",1).record(),!1}}return!0},e.canMouseDown=function(e){return setTimeout((()=>{let{after:r,before:t,value:i}=e.$();if(!i){let c,l,o="\ufeff",u=a.split("([\\w:.-]+)").join("((?:[\\w:.-]|"+o+")+)"),s=f(u),p=t+i+o+r;for(;c=s.exec(p);)if(-1!==c[0].indexOf(o)){e.select(l=c.index,l+n(c[0])-1);break}}}),1),!0},e.state=d,e.that=p}));