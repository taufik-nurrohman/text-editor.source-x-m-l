/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return e&&c(r)&&e instanceof r},i=function(e){return o(e)&&0==e%1},o=function(e){return"number"==typeof e},c=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},f=function(e){return e.length},s=function(e){return Object.keys(e)},u=function(e,r){return function(e){return n(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,c(r)?r:"g"))},a=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},l=function e(r){if(function(e){return Array.isArray(e)}(r))return r.map((function(t){return e(r)}));if(function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||n(e,Object))}(r)){for(var t in r)r[t]=e(r[t]);return r}return!1===r?"false":null===r?"null":!0===r?"true":""+r},d=function(e){return e&&e.preventDefault()},p=function(){return"[\\w:.-]+"},v=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},x=function(e){return"</("+e+")>"},$=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+x(p())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+p()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+v(p())+")"},b=(e=function(e,r){var t=r.$(),n=t.after,i=t.before,o=t.end,c=t.value;if(!c)for(var s,a,l,v="\ufeff",x=$().split("("+p()+")").join("((?:"+p()+"|\ufeff)+)"),b=u(x),m=i+c+v+n;s=b.exec(m);)if(l=v,-1!==s[0].indexOf(l)){d(e);var h=s[0].split(v);if(">"===h[1]||"/>"===(h[1]||"").trim()){r.select(a=s.index,a+f(s[0])-1);break}if("<"!==h[0]&&"</"!==h[0]&&!/\s/.test(h[0])){r.select(a=s.index+("/"===h[0][1]?2:1),o+f(h[1].split(/[\s\/>]/).shift()));break}var w=void 0;if(w=u("=(\"[^\"]*\ufeff[^\"]*\"|'[^']*\ufeff[^']*')").exec(s[0])){r.select(a=s.index+w.index+2,a+f(w[1])-3);break}if(w=u("=([^\"'\\s\\/>]*\ufeff[^\"'\\s\\/>]*)").exec(s[0])){r.select(a=s.index+w.index+1,a+f(w[1])-1);break}if("<"!==h[0]&&"</"!==h[0]&&(w=u("([^=\"'\\s]*\ufeff[^=\"'\\s]*)[=\\s\\/>]").exec(s[0]))){r.select(a=s.index+w.index,a+f(w[1])-1);break}r.select(a=s.index,a+f(s[0])-1);break}},r=1,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function m(e){var r,t=this,n=t.k(!1).pop(),o=t.k();if(t&&!e.defaultPrevented&&!t.keys[o]&&"Alt"!==o&&"Control"!==o){var c=t.$(),s=c.after,a=c.before;c.end;var l=c.start,b=c.value;if(["-",">","/","?"," "].includes(n)){if("-"===n)return b||"<!-"!==a.slice(-3)?void 0:(d(e),t.wrap("- "," --"+(">"===s[0]?"":">")).record());if(">"===n||"/"===n){var m=u(v(p())+"$","").exec(a+">");if(!b&&m){if(d(e),"/"===n)return">"===s[0]?t.trim("",!1).insert(" /",-1).select(t.$().start+1).record():t.trim("",!1).insert(" />",-1).record();s.startsWith("></"+m[1]+">")?t.select(l+1).record():s.startsWith("</"+m[1]+">")?t.insert(">",-1).record():t.wrap(">","</"+m[1]+(">"===s[0]?"":">")).record()}return}return"?"===n?b||"<"!==a.slice(-1)?void 0:(d(e),t.wrap("?","?"+(">"===s[0]?"":">")).record()):" "===n&&!b&&("--\x3e"===s.slice(0,3)&&"\x3c!--"===a.slice(-4)||"?>"===s.slice(0,2)&&"<?"===a.slice(0,2)&&/<\?\S*$/.test(a))?(d(e),t.wrap(" "," ").record()):void 0}var h=t.$();if(s=h.after,a=h.before,h.end,l=h.start,b=h.value,"ArrowLeft"!==o){if("ArrowRight"!==o){var w=(null==(r=t.state.source)?void 0:r.tab)||t.state.tab||"\t",g=a.split("\n").pop().match(/^(\s+)/),k=g&&g[1]||"";if(i(w)&&(w=" ".repeat(w)),"Enter"!==o){if("Backspace"!==o){if("Delete"===o&&!b){if("--\x3e"===s.slice(0,3))return d(e),t.replace(/^-->/,"",1).record();if("?>"===s.slice(0,2))return d(e),t.replace(/^\?>/,"",1).record();var y=u("^"+$(),"");if(y.exec(s))return d(e),t.replace(y,"",1).record()}}else if(!b){if("\x3c!--"===a.slice(-4))return d(e),t.replace(/<!--$/,"",-1),"--\x3e"===s.slice(0,3)&&t.replace(/^-->/,"",1),t.record();if(/^\s+-->/.test(s)&&/<!--\s+$/.test(a))return d(e),t.trim(" "===a.slice(-1)?"":" "," "===s[0]?"":" ").record();if(/<\?\S*$/.test(a))return d(e),t.replace(/<\?\S*$/,"",-1),"?>"===s.slice(0,2)&&t.replace(/^\?>/,"",1),t.record();if(/^\s+\?>/.test(s)&&/<\?\S*\s+$/.test(a))return d(e),t.trim(" "===a.slice(-1)?"":" "," "===s[0]?"":" ").record();var L=u($()+"$",""),S=L.exec(a);if(S){if(d(e)," />"===a.slice(-3))return t.replace(/ \/>$/,"/>",-1).record();if("/>"===a.slice(-2))return t.replace(/\/>$/,">",-1).record();t.replace(L,"",-1);var M=S[0].slice(1).split(/\s+|>/)[0];return S[0]&&"/"!==S[0][1]&&s.startsWith("</"+M+">")&&t.replace(u("^</"+M+">",""),"",1),t.record()}if(u("(^|\\n)([ \\t]*)"+v(p())+"\\n\\2?$","").test(a)&&u("^\\s*"+x(p()),"").test(s))return d(e),t.trim().record()}}else{var T=a.match(u(v(p())+"$",""));if(!b){if(T)return d(e),s.startsWith("</"+T[1]+">")?t.record().trim().wrap("\n"+k+w,"\n"+k).record():t.record().wrap("\n"+k+w,"\n"+k+"</"+T[1]+">").record();if(/^[ \t]*-->/.test(s)&&/<!--[ \t]*$/.test(a)||/^[ \t]*\?>/.test(s)&&/<\?\S*[ \t]*$/.test(a))return d(e),t.trim().wrap("\n"+k,"\n"+k).record();if(/^\n-->/.test(s)&&/<!--\n$/.test(a)||/^\n\?>/.test(s)&&/<\?\S*\n$/.test(a))return d(e),t.trim().wrap("\n\n"+k,"\n\n"+k).record()}}}else if(!b){var X=u("^"+$(),"").exec(s);if(X)return d(e),t.select(l,l+f(X[0]))}}else if(!b){var E=u($()+"$","").exec(a);if(E)return d(e),t.select(l-f(E[0]),l)}}}function h(e){var r=this;r.k(!1).pop();var t=r.k();r&&!e.defaultPrevented&&(t.startsWith("Control-")||b(e,r))}function w(e){if(!e)return"";e=s(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+a(l(t),!0)+'"'));return n}return{attach:function(){var e,r=this;return r.insertXML=function(e,t,n,o){if(void 0===t&&(t=""),void 0===n&&(n={}),void 0===o&&(o=!1),o){var c,f=r.$(),s=f.after,a=f.before,l=(null==(c=r.state.source)?void 0:c.tab)||r.state.tab||"\t";if(i(l)&&(l=" ".repeat(l)),u("^"+x(p()),"").test(s)&&u(v(p())+"$","").test(a)){var d=a.split("\n").pop().match(/^(\s+)/),$=d&&d[1]||"";r.wrap("\n"+l+$,"\n"+$)}}return r.insert("<"+e+w(n)+(!1!==t?">"+t+"</"+e+">":" />"),-1,!0)},r.peelXML=function(e,t,n,i){return void 0===i&&(i=!1),i&&r.trim("",""),r.replace(u(v(e)+"$",""),"",-1).replace(u("^"+x(e)),"",1)},r.toggleXML=function(e,t,n,i){void 0===t&&(t=""),void 0===n&&(n={}),void 0===i&&(i=!1);var o=r.$(),c=o.after,f=o.before,s=v(e),a=x(e),l=u(s+"$",""),d=u("^"+a,""),p=l.test(f),$=d.test(c);return r[(p&&$?"peel":"wrap")+"XML"](e,t,n,i)},r.wrapXML=function(e,t,n,o){void 0===t&&(t=""),void 0===n&&(n={}),void 0===o&&(o=!1);var c=r.$(),f=c.after,s=c.before;if(!c.value&&t&&r.insert(t),o){var a,l=(null==(a=r.state.source)?void 0:a.tab)||r.state.tab||"\t";if(i(l)&&(l=" ".repeat(l)),u("^"+x(p()),"").test(f)&&u(v(p())+"$","").test(s)){var d=s.split("\n").pop().match(/^(\s+)/),$=d&&d[1]||"";r.wrap("\n"+l+$,"\n"+$)}}return r.wrap("<"+e+w(n)+">","</"+e+">")},"XML"===(null==(e=r.state.source)?void 0:e.type)&&(r.on("key.down",m),r.on("mouse.down",h)),r},detach:function(){var e=this;return e.off("key.down",m),e.off("mouse.down",h),e}}}));