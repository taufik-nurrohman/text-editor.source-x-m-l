/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.SourceXML=r())}(this,(function(){"use strict";var e=function(e){return Array.isArray(e)},r=function(e,r){return e&&s(r)&&e instanceof r},t=function(e){return n(e)&&0==e%1},n=function(e){return"number"==typeof e},i=function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||r(e,Object))},s=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},c=function(e){return e.length},l=function(e){return Object.keys(e)},u=function(e,t){return function(e){return r(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,s(t)?t:"g"))},a=function(e,r){return e=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),r&&(e=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;")),e},o=function r(){for(var t=arguments.length,n=Array(t),l=0;l<t;l++)n[l]=arguments[l];for(var u,a=n.shift(),o=0,f=c(n);o<f;++o)for(var p in n[o])if(s(a[p]))if(e(a[p])&&e(n[o][p])){a[p]=[].concat(a[p]);for(var d=0,m=c(n[o][p]);d<m;++d)u=n[o][p][d],-1===a[p].indexOf(u)&&a[p].push(n[o][p][d])}else i(a[p])&&i(n[o][p])?a[p]=r({},a[p],n[o][p]):a[p]=n[o][p];else a[p]=n[o][p];return a},f=function r(t){if(e(t))return t.map((function(e){return r(t)}));if(i(t)){for(var n in t)t[n]=r(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},p=function(e){return e&&e.preventDefault()},d=function(e){return"</("+e+")>"},m=function(){return"[\\w:.-]+"},$=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(){return"(?:\x3c!--([\\s\\S](?!--\x3e)*)--\x3e|<!((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)>|"+d(m())+"|<\\?((?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^>'\"])*)\\?>|"+("<("+m()+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?/?>|")+$(m())+")"};function A(e){var r,n=this,i=n.k(!1).pop(),s=n.k();if(!e.defaultPrevented&&!n.keys[s]&&"Alt"!==s&&"Control"!==s){var l=n.$(),a=l.after,o=l.before;l.end;var f=l.start,A=l.value;if(["-",">","/","?"," "].includes(i)){if("-"===i)return A||"<!-"!==o.slice(-3)?void 0:(p(e),n.wrap("- "," --"+(">"===a[0]?"":">")).record());if(">"===i||"/"===i){var x=u($(m())+"$","").exec(o+">");if(!A&&x){if(p(e),"/"===i)return">"===a[0]?n.trim("",!1).insert(" /",-1).select(n.$().start+1).record():n.trim("",!1).insert(" />",-1).record();a.startsWith("></"+x[1]+">")?n.select(f+1).record():a.startsWith("</"+x[1]+">")?n.insert(">",-1).record():n.wrap(">","</"+x[1]+(">"===a[0]?"":">")).record()}return}return"?"===i?A||"<"!==o.slice(-1)?void 0:(p(e),n.wrap("?","?"+(">"===a[0]?"":">")).record()):" "===i&&!A&&("--\x3e"===a.slice(0,3)&&"\x3c!--"===o.slice(-4)||"?>"===a.slice(0,2)&&/<\?\S*$/.test(o))?(p(e),n.wrap(" "," ").record()):void 0}var g=n.$();if(a=g.after,o=g.before,g.end,f=g.start,A=g.value,"ArrowLeft"!==s){if("ArrowRight"!==s){var w=(null==(r=n.state.source)?void 0:r.tab)||n.state.tab||"\t",D=o.split("\n").pop().match(/^(\s+)/),h=D&&D[1]||"";if(t(w)&&(w=" ".repeat(w)),"Enter"===s){if(A)return;if(/^[ \t]*-->/.test(a)&&/<!--[ \t]*$/.test(o)||/^[ \t]*\?>/.test(a)&&/<\?\S*[ \t]*$/.test(o)||/^[ \t]*\]\]>/.test(a)&&/<!\[CDATA\[[ \t]*$/.test(o))return p(e),n.trim("\n"+h,"\n"+h).record();if(/^(\n[ \t]*)-->/.test(a)&&/<!--(\n[ \t]*)$/.test(o)||/^(\n[ \t]*)\?>/.test(a)&&/<\?\S*(\n[ \t]*)$/.test(o)||/^(\n[ \t]*)\]\]>/.test(a)&&/<!\[CDATA\[(\n[ \t]*)$/.test(o))return p(e),n.trim("\n\n"+h,"\n\n"+h).record();var C=o.match(u($(m())+"$",""));if(C)return p(e),a.startsWith("</"+C[1]+">")?n.record().trim("\n"+h+w,"\n"+h).record():n.record().wrap("\n"+h+w,"\n"+h+"</"+C[1]+">").record()}if("Backspace"===s){if(A)return;if("\x3c!--"===o.slice(-4))return p(e),n.replace(/<!--$/,"",-1),"--\x3e"===a.slice(0,3)&&n.replace(/^-->/,"",1),n.record();if(/^(\n[ \t]*){2,}-->/.test(a)&&/<!--(\n[ \t]*){2,}$/.test(o))return p(e),n.trim("\n"+h,"\n"+h).record();if(/^\s+-->/.test(a)&&/<!--\s+$/.test(o)){p(e);var T=a[0],b=o.slice(-1),y=" "===T&&" "===b?"":" ";return n.trim(y,y).record()}if(/<\?\S*$/.test(o))return p(e),n.replace(/<\?\S*$/,"",-1),"?>"===a.slice(0,2)&&n.replace(/^\?>/,"",1),n.record();if(/^(\n[ \t]*){2,}\?>/.test(a)&&/<\?\S*(\n[ \t]*){2,}$/.test(o))return p(e),n.trim("\n"+h,"\n"+h).record();if(/^\s+\?>/.test(a)&&/<\?\S*\s+$/.test(o)){p(e);var S=a[0],E=o.slice(-1),k=" "===S&&" "===E?"":" ";return n.trim(k,k).record()}if("<![CDATA["===o.slice(-9))return p(e),n.replace(/<!\[CDATA\[$/,"",-1),"]]>"===a.slice(0,3)&&n.replace(/^\]\]>/,"",1),n.record();if(/^(\n[ \t]*){2,}\]\]>/.test(a)&&/<!\[CDATA\[(\n[ \t]*){2,}$/.test(o))return p(e),n.trim("\n"+h,"\n"+h).record();if(/^\s+\]\]>/.test(a)&&/<!\[CDATA\[\s+$/.test(o)){p(e);var j=a[0],W=o.slice(-1),L=" "===j&&" "===W?"":" ";return n.trim(L,L).record()}var O=u(v()+"$",""),R=O.exec(o);if(R){if(p(e)," />"===o.slice(-3))return n.replace(/ \/>$/,"/>",-1).record();if("/>"===o.slice(-2))return n.replace(/\/>$/,">",-1).record();n.replace(O,"",-1);var M=R[0].slice(1).split(/\s+|>/)[0];return R[0]&&"/"!==R[0][1]&&a.startsWith("</"+M+">")&&n.replace(u("^</"+M+">",""),"",1),n.record()}if(u("(^|\\n)([ \\t]*)"+$(m())+"\\n\\2$","").test(o)&&u("^\\s*"+d(m()),"").test(a))return p(e),n.trim().record()}if("Delete"===s){if(A)return;if("--\x3e"===a.slice(0,3))return p(e),n.replace(/^-->/,"",1).record();if("?>"===a.slice(0,2))return p(e),n.replace(/^\?>/,"",1).record();var X=u("^"+v(),"");if(X.exec(a))return p(e),n.replace(X,"",1).record()}}else if(!A){var q=u("^"+v(),"").exec(a);if(q)return p(e),n.select(f,f+c(q[0]))}}else if(!A){var B=u(v()+"$","").exec(o);if(B)return p(e),n.select(f-c(B[0]),f)}}}function x(e){if(!e)return"";e=l(e).sort().reduce((function(r,t){return r[t]=e[t],r}),{});var r,t,n="";for(r in e)!1!==(t=e[r])&&null!==t&&(n+=" "+r,!0!==t&&(n+='="'+a(f(t),!0)+'"'));return n}return{attach:function(){var r,t,n=this,i=/^\s*([\s\S]*?)\s*$/,c=/^<!--\s*([\s\S]*?)\s*-->$/,l=/^<!\[CDATA\[\s*([\s\S]*?)\s*\]\]>$/;return n.state=t=o({elements:{}},n.state),n.insertComment=function(e,r,t){return n.insert("\x3c!-- "+e+" --\x3e",s(r)?r:-1,!s(t)||t)},n.insertData=function(e,r,t){return n.insert("<![CDATA["+e+"]]>",s(r)?r:-1,!s(t)||t)},n.insertElement=function(r,i,c){if(e(r)){var l,u;if(s(t.elements[r[0]]))r[0]=null!=(l=r[0])?l:t.elements[r[0]][0],r[1]=null!=(u=r[1])?u:t.elements[r[0]][1],r[2]=o({},t.elements[r[0]][2]||{},r[2]||{});r="<"+r[0]+x(r[2])+(!1===r[1]?" />":">"+(r[1]||"")+"</"+r[0]+">")}return n.insert(r,s(i)?i:-1,!s(c)||c)},n.peelComment=function(e){return e?n.replace(c,"$1"):n.replace(/<!--\s*$/,"",-1).replace(/^\s*-->/,"",1)},n.peelData=function(e){return e?n.replace(l,"$1"):n.replace(/<!\[CDATA\[\s*$/,"",-1).replace(/^\s*\]\]>/,"",1)},n.peelElement=function(r,i,c){if(e(r)){var l,a;if(s(t.elements[r[0]]))r[0]=null!=(l=r[0])?l:t.elements[r[0]][0],r[1]=null!=(a=r[1])?a:t.elements[r[0]][1],r[2]=o({},t.elements[r[0]][2]||{},r[2]||{});return(c=i)?n.replace(u("^"+$(r[0])+"([\\s\\S]*?)"+d(r[0])+"$",""),"$3"):n.replace(u($(r[0])+"$",""),"",-1).replace(u("^"+d(r[0])),"",1)}return n.peel(r,i,c)},n.toggleComment=function(e){var r=n.$(),t=r.after,i=r.before,s=r.value;return e?n[(c.test(s)?"peel":"wrap")+"Comment"](e):n[(/<!--\s*$/.test(i)&&/^\s*-->/.test(t)?"peel":"wrap")+"Comment"](e)},n.toggleData=function(e){var r=n.$(),t=r.after,i=r.before,s=r.value;return e?n[(l.test(s)?"peel":"wrap")+"Data"](e):n[(/<!\[CDATA\[\s*$/.test(i)&&/^\s*\]\]>/.test(t)?"peel":"wrap")+"Data"](e)},n.toggleElement=function(r,i,c){if(e(r)){var l,a;if(s(t.elements[r[0]]))r[0]=null!=(l=r[0])?l:t.elements[r[0]][0],r[1]=null!=(a=r[1])?a:t.elements[r[0]][1],r[2]=o({},t.elements[r[0]][2]||{},r[2]||{});c=i;var f=n.$(),p=f.after,m=f.before,v=f.value,A=$(r[0]),x=d(r[0]);return c?n[(u("^"+A+"[\\s\\S]*?"+x+"$","").test(v)?"peel":"wrap")+"Element"](r,i,c):n[(u(A+"$","").test(m)&&u("^"+x,"").test(p)?"peel":"wrap")+"Element"](r,i,c)}return n.toggle(r,i,c)},n.wrapComment=function(e){return e?n.replace(i,"\x3c!-- $1 --\x3e"):n.trim(!1,!1).replace(/$/,"\x3c!-- ",-1).replace(/^/," --\x3e",1)},n.wrapData=function(e){return e?n.replace(i,"<![CDATA[$1]]>"):n.trim(!1,!1).replace(/$/,"<![CDATA[",-1).replace(/^/,"]]>",1)},n.wrapElement=function(r,c,l){if(e(r)){var u,a;if(s(t.elements[r[0]]))r[0]=null!=(u=r[0])?u:t.elements[r[0]][0],r[1]=null!=(a=r[1])?a:t.elements[r[0]][1],r[2]=o({},t.elements[r[0]][2]||{},r[2]||{});l=c;var f=n.$().value;return l?n.replace(i,"<"+r[0]+x(r[2])+">"+(f||r[1]||"").trim()+"</"+r[0]+">"):n.trim(!1,!1).replace(/$/,"<"+r[0]+x(r[2])+">",-1).replace(/^/,"</"+r[0]+">",1).insert(f||r[1]||"")}return n.wrap(r,c,l)},"XML"===(null==(r=n.state.source)?void 0:r.type)&&n.on("key.down",A),n},detach:function(){return this.off("key.down",A)}}}));